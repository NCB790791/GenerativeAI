"use strict";
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.IdentityPool = exports.IdentityPoolProviderUrl = exports.IdentityPoolProviderType = void 0;
const jsiiDeprecationWarnings = require("../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const aws_cognito_1 = require("aws-cdk-lib/aws-cognito");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const core_1 = require("aws-cdk-lib/core");
const identitypool_role_attachment_1 = require("./identitypool-role-attachment");
/**
 * Types of Identity Pool Login Providers
 */
var IdentityPoolProviderType;
(function (IdentityPoolProviderType) {
    /** Facebook Provider type */
    IdentityPoolProviderType["FACEBOOK"] = "Facebook";
    /** Google Provider Type */
    IdentityPoolProviderType["GOOGLE"] = "Google";
    /** Amazon Provider Type */
    IdentityPoolProviderType["AMAZON"] = "Amazon";
    /** Apple Provider Type */
    IdentityPoolProviderType["APPLE"] = "Apple";
    /** Twitter Provider Type */
    IdentityPoolProviderType["TWITTER"] = "Twitter";
    /** Digits Provider Type */
    IdentityPoolProviderType["DIGITS"] = "Digits";
    /** Open Id Provider Type */
    IdentityPoolProviderType["OPEN_ID"] = "OpenId";
    /** Saml Provider Type */
    IdentityPoolProviderType["SAML"] = "Saml";
    /** User Pool Provider Type */
    IdentityPoolProviderType["USER_POOL"] = "UserPool";
    /** Custom Provider Type */
    IdentityPoolProviderType["CUSTOM"] = "Custom";
})(IdentityPoolProviderType || (exports.IdentityPoolProviderType = IdentityPoolProviderType = {}));
/**
 * Keys for Login Providers - correspond to client id's of respective federation identity providers
 */
class IdentityPoolProviderUrl {
    /** OpenId Provider Url */
    static openId(url) {
        return new IdentityPoolProviderUrl(IdentityPoolProviderType.OPEN_ID, url);
    }
    /** Saml Provider Url */
    static saml(url) {
        return new IdentityPoolProviderUrl(IdentityPoolProviderType.SAML, url);
    }
    /** User Pool Provider Url */
    static userPool(userPool, userPoolClient) {
        const url = `${userPool.userPoolProviderName}:${userPoolClient.userPoolClientId}`;
        return new IdentityPoolProviderUrl(IdentityPoolProviderType.USER_POOL, url);
    }
    /** Custom Provider Url */
    static custom(url) {
        return new IdentityPoolProviderUrl(IdentityPoolProviderType.CUSTOM, url);
    }
    constructor(
    /** type of Provider Url */
    type, 
    /** value of Provider Url */
    value) {
        this.type = type;
        this.value = value;
        try {
            jsiiDeprecationWarnings._aws_cdk_aws_cognito_identitypool_alpha_IdentityPoolProviderType(type);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, IdentityPoolProviderUrl);
            }
            throw error;
        }
    }
}
exports.IdentityPoolProviderUrl = IdentityPoolProviderUrl;
_a = JSII_RTTI_SYMBOL_1;
IdentityPoolProviderUrl[_a] = { fqn: "@aws-cdk/aws-cognito-identitypool-alpha.IdentityPoolProviderUrl", version: "2.154.1-alpha.0" };
/** Facebook Provider Url */
IdentityPoolProviderUrl.FACEBOOK = new IdentityPoolProviderUrl(IdentityPoolProviderType.FACEBOOK, 'graph.facebook.com');
/** Google Provider Url */
IdentityPoolProviderUrl.GOOGLE = new IdentityPoolProviderUrl(IdentityPoolProviderType.GOOGLE, 'accounts.google.com');
/** Amazon Provider Url */
IdentityPoolProviderUrl.AMAZON = new IdentityPoolProviderUrl(IdentityPoolProviderType.AMAZON, 'www.amazon.com');
/** Apple Provider Url */
IdentityPoolProviderUrl.APPLE = new IdentityPoolProviderUrl(IdentityPoolProviderType.APPLE, 'appleid.apple.com');
/** Twitter Provider Url */
IdentityPoolProviderUrl.TWITTER = new IdentityPoolProviderUrl(IdentityPoolProviderType.TWITTER, 'api.twitter.com');
/** Digits Provider Url */
IdentityPoolProviderUrl.DIGITS = new IdentityPoolProviderUrl(IdentityPoolProviderType.DIGITS, 'www.digits.com');
/**
 * Define a Cognito Identity Pool
 *
 *  @resource AWS::Cognito::IdentityPool
 */
class IdentityPool extends core_1.Resource {
    /**
     * Import an existing Identity Pool from its id
     */
    static fromIdentityPoolId(scope, id, identityPoolId) {
        const identityPoolArn = core_1.Stack.of(scope).formatArn({
            service: 'cognito-identity',
            resource: 'identitypool',
            resourceName: identityPoolId,
            arnFormat: core_1.ArnFormat.SLASH_RESOURCE_NAME,
        });
        return IdentityPool.fromIdentityPoolArn(scope, id, identityPoolArn);
    }
    /**
     * Import an existing Identity Pool from its Arn
     */
    static fromIdentityPoolArn(scope, id, identityPoolArn) {
        const pool = core_1.Stack.of(scope).splitArn(identityPoolArn, core_1.ArnFormat.SLASH_RESOURCE_NAME);
        const res = pool.resourceName || '';
        if (!res) {
            throw new Error('Invalid Identity Pool ARN');
        }
        if (!core_1.Token.isUnresolved(res)) {
            const idParts = res.split(':');
            if (!(idParts.length === 2)) {
                throw new Error('Invalid Identity Pool Id: Identity Pool Ids must follow the format <region>:<id>');
            }
            if (!core_1.Token.isUnresolved(pool.region) && idParts[0] !== pool.region) {
                throw new Error('Invalid Identity Pool Id: Region in Identity Pool Id must match stack region');
            }
        }
        class ImportedIdentityPool extends core_1.Resource {
            constructor() {
                super(scope, id, {
                    account: pool.account,
                    region: pool.region,
                });
                this.identityPoolId = res;
                this.identityPoolArn = identityPoolArn;
                this.identityPoolName = this.physicalName;
            }
        }
        return new ImportedIdentityPool();
    }
    constructor(scope, id, props = {}) {
        super(scope, id, {
            physicalName: props.identityPoolName,
        });
        /**
         * List of Identity Providers added in constructor for use with property overrides
         */
        this.cognitoIdentityProviders = [];
        /**
         * Running count of added role attachments
         */
        this.roleAttachmentCount = 0;
        try {
            jsiiDeprecationWarnings._aws_cdk_aws_cognito_identitypool_alpha_IdentityPoolProps(props);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, IdentityPool);
            }
            throw error;
        }
        const authProviders = props.authenticationProviders || {};
        const providers = authProviders.userPools ? authProviders.userPools.map(userPool => userPool.bind(this, this)) : undefined;
        if (providers && providers.length)
            this.cognitoIdentityProviders = providers;
        const openIdConnectProviderArns = authProviders.openIdConnectProviders ?
            authProviders.openIdConnectProviders.map(openIdProvider => openIdProvider.openIdConnectProviderArn) : undefined;
        const samlProviderArns = authProviders.samlProviders ?
            authProviders.samlProviders.map(samlProvider => samlProvider.samlProviderArn) : undefined;
        let supportedLoginProviders = {};
        if (authProviders.amazon)
            supportedLoginProviders[IdentityPoolProviderUrl.AMAZON.value] = authProviders.amazon.appId;
        if (authProviders.facebook)
            supportedLoginProviders[IdentityPoolProviderUrl.FACEBOOK.value] = authProviders.facebook.appId;
        if (authProviders.google)
            supportedLoginProviders[IdentityPoolProviderUrl.GOOGLE.value] = authProviders.google.clientId;
        if (authProviders.apple)
            supportedLoginProviders[IdentityPoolProviderUrl.APPLE.value] = authProviders.apple.servicesId;
        if (authProviders.twitter)
            supportedLoginProviders[IdentityPoolProviderUrl.TWITTER.value] = `${authProviders.twitter.consumerKey};${authProviders.twitter.consumerSecret}`;
        if (authProviders.digits)
            supportedLoginProviders[IdentityPoolProviderUrl.DIGITS.value] = `${authProviders.digits.consumerKey};${authProviders.digits.consumerSecret}`;
        if (!Object.keys(supportedLoginProviders).length)
            supportedLoginProviders = undefined;
        const cfnIdentityPool = new aws_cognito_1.CfnIdentityPool(this, 'Resource', {
            allowUnauthenticatedIdentities: props.allowUnauthenticatedIdentities ? true : false,
            allowClassicFlow: props.allowClassicFlow,
            identityPoolName: this.physicalName,
            developerProviderName: authProviders.customProvider,
            openIdConnectProviderArns,
            samlProviderArns,
            supportedLoginProviders,
            cognitoIdentityProviders: core_1.Lazy.any({ produce: () => this.cognitoIdentityProviders }),
        });
        this.identityPoolName = cfnIdentityPool.attrName;
        this.identityPoolId = cfnIdentityPool.ref;
        this.identityPoolArn = core_1.Stack.of(scope).formatArn({
            service: 'cognito-identity',
            resource: 'identitypool',
            resourceName: this.identityPoolId,
            arnFormat: core_1.ArnFormat.SLASH_RESOURCE_NAME,
        });
        this.authenticatedRole = props.authenticatedRole ? props.authenticatedRole : this.configureDefaultRole('Authenticated');
        this.unauthenticatedRole = props.unauthenticatedRole ? props.unauthenticatedRole : this.configureDefaultRole('Unauthenticated');
        const attachment = new identitypool_role_attachment_1.IdentityPoolRoleAttachment(this, 'DefaultRoleAttachment', {
            identityPool: this,
            authenticatedRole: this.authenticatedRole,
            unauthenticatedRole: this.unauthenticatedRole,
            roleMappings: props.roleMappings,
        });
        // This added by the original author, but it's causing cyclic dependencies.
        // Don't know why this was added in the first place, but I'm disabling it for now and if
        // no complaints come from this, we're probably safe to remove it altogether.
        // attachment.node.addDependency(this);
        Array.isArray(attachment);
    }
    /**
     * Add a User Pool to the IdentityPool and configure User Pool Client to handle identities
     */
    addUserPoolAuthentication(userPool) {
        try {
            jsiiDeprecationWarnings._aws_cdk_aws_cognito_identitypool_alpha_IUserPoolAuthenticationProvider(userPool);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.addUserPoolAuthentication);
            }
            throw error;
        }
        const providers = userPool.bind(this, this);
        this.cognitoIdentityProviders = this.cognitoIdentityProviders.concat(providers);
    }
    /**
     * Adds Role Mappings to Identity Pool
    */
    addRoleMappings(...roleMappings) {
        try {
            jsiiDeprecationWarnings._aws_cdk_aws_cognito_identitypool_alpha_IdentityPoolRoleMapping(roleMappings);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.addRoleMappings);
            }
            throw error;
        }
        if (!roleMappings || !roleMappings.length)
            return;
        this.roleAttachmentCount++;
        const name = 'RoleMappingAttachment' + this.roleAttachmentCount.toString();
        const attachment = new identitypool_role_attachment_1.IdentityPoolRoleAttachment(this, name, {
            identityPool: this,
            authenticatedRole: this.authenticatedRole,
            unauthenticatedRole: this.unauthenticatedRole,
            roleMappings,
        });
        // This added by the original author, but it's causing cyclic dependencies.
        // Don't know why this was added in the first place, but I'm disabling it for now and if
        // no complaints come from this, we're probably safe to remove it altogether.
        // attachment.node.addDependency(this);
        Array.isArray(attachment);
    }
    /**
     * Configure Default Roles For Identity Pool
     */
    configureDefaultRole(type) {
        const assumedBy = this.configureDefaultGrantPrincipal(type.toLowerCase());
        const role = new aws_iam_1.Role(this, `${type}Role`, {
            description: `Default ${type} Role for Identity Pool ${this.identityPoolName}`,
            assumedBy,
        });
        return role;
    }
    configureDefaultGrantPrincipal(type) {
        return new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
            'StringEquals': {
                'cognito-identity.amazonaws.com:aud': this.identityPoolId,
            },
            'ForAnyValue:StringLike': {
                'cognito-identity.amazonaws.com:amr': type,
            },
        }, 'sts:AssumeRoleWithWebIdentity');
    }
}
exports.IdentityPool = IdentityPool;
_b = JSII_RTTI_SYMBOL_1;
IdentityPool[_b] = { fqn: "@aws-cdk/aws-cognito-identitypool-alpha.IdentityPool", version: "2.154.1-alpha.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRlbnRpdHlwb29sLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaWRlbnRpdHlwb29sLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLHlEQUlpQztBQUNqQyxpREFNNkI7QUFDN0IsMkNBTzBCO0FBSTFCLGlGQUd3QztBQTJFeEM7O0dBRUc7QUFDSCxJQUFZLHdCQXFCWDtBQXJCRCxXQUFZLHdCQUF3QjtJQUNsQyw2QkFBNkI7SUFDN0IsaURBQXFCLENBQUE7SUFDckIsMkJBQTJCO0lBQzNCLDZDQUFpQixDQUFBO0lBQ2pCLDJCQUEyQjtJQUMzQiw2Q0FBaUIsQ0FBQTtJQUNqQiwwQkFBMEI7SUFDMUIsMkNBQWUsQ0FBQTtJQUNmLDRCQUE0QjtJQUM1QiwrQ0FBbUIsQ0FBQTtJQUNuQiwyQkFBMkI7SUFDM0IsNkNBQWlCLENBQUE7SUFDakIsNEJBQTRCO0lBQzVCLDhDQUFrQixDQUFBO0lBQ2xCLHlCQUF5QjtJQUN6Qix5Q0FBYSxDQUFBO0lBQ2IsOEJBQThCO0lBQzlCLGtEQUFzQixDQUFBO0lBQ3RCLDJCQUEyQjtJQUMzQiw2Q0FBaUIsQ0FBQTtBQUNuQixDQUFDLEVBckJXLHdCQUF3Qix3Q0FBeEIsd0JBQXdCLFFBcUJuQztBQUVEOztHQUVHO0FBQ0gsTUFBYSx1QkFBdUI7SUFtQmxDLDBCQUEwQjtJQUNuQixNQUFNLENBQUMsTUFBTSxDQUFDLEdBQVc7UUFDOUIsT0FBTyxJQUFJLHVCQUF1QixDQUFDLHdCQUF3QixDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztLQUMzRTtJQUVELHdCQUF3QjtJQUNqQixNQUFNLENBQUMsSUFBSSxDQUFDLEdBQVc7UUFDNUIsT0FBTyxJQUFJLHVCQUF1QixDQUFDLHdCQUF3QixDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztLQUN4RTtJQUVELDZCQUE2QjtJQUN0QixNQUFNLENBQUMsUUFBUSxDQUFDLFFBQWtCLEVBQUUsY0FBOEI7UUFDdkUsTUFBTSxHQUFHLEdBQUcsR0FB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LEVBQUUsK0JBQStCLENBQUMsQ0FBQztLQUNyQzs7QUFwTUgsb0NBcU1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ2ZuSWRlbnRpdHlQb29sLFxuICBVc2VyUG9vbCxcbiAgVXNlclBvb2xDbGllbnQsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1jb2duaXRvJztcbmltcG9ydCB7XG4gIElPcGVuSWRDb25uZWN0UHJvdmlkZXIsXG4gIElTYW1sUHJvdmlkZXIsXG4gIFJvbGUsXG4gIEZlZGVyYXRlZFByaW5jaXBhbCxcbiAgSVJvbGUsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0IHtcbiAgUmVzb3VyY2UsXG4gIElSZXNvdXJjZSxcbiAgU3RhY2ssXG4gIEFybkZvcm1hdCxcbiAgTGF6eSxcbiAgVG9rZW4sXG59IGZyb20gJ2F3cy1jZGstbGliL2NvcmUnO1xuaW1wb3J0IHtcbiAgQ29uc3RydWN0LFxufSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7XG4gIElkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50LFxuICBJZGVudGl0eVBvb2xSb2xlTWFwcGluZyxcbn0gZnJvbSAnLi9pZGVudGl0eXBvb2wtcm9sZS1hdHRhY2htZW50JztcbmltcG9ydCB7XG4gIElVc2VyUG9vbEF1dGhlbnRpY2F0aW9uUHJvdmlkZXIsXG59IGZyb20gJy4vaWRlbnRpdHlwb29sLXVzZXItcG9vbC1hdXRoZW50aWNhdGlvbi1wcm92aWRlcic7XG5cbi8qKlxuICogUmVwcmVzZW50cyBhIENvZ25pdG8gSWRlbnRpdHlQb29sXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSUlkZW50aXR5UG9vbCBleHRlbmRzIElSZXNvdXJjZSB7XG4gIC8qKlxuICAgKiBUaGUgaWQgb2YgdGhlIElkZW50aXR5IFBvb2wgaW4gdGhlIGZvcm1hdCBSRUdJT046R1VJRFxuICAgKiBAYXR0cmlidXRlXG4gICAqL1xuICByZWFkb25seSBpZGVudGl0eVBvb2xJZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgQVJOIG9mIHRoZSBJZGVudGl0eSBQb29sXG4gICAqIEBhdHRyaWJ1dGVcbiAgICovXG4gIHJlYWRvbmx5IGlkZW50aXR5UG9vbEFybjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBOYW1lIG9mIHRoZSBJZGVudGl0eSBQb29sXG4gICAqIEBhdHRyaWJ1dGVcbiAgICovXG4gIHJlYWRvbmx5IGlkZW50aXR5UG9vbE5hbWU6IHN0cmluZztcbn1cblxuLyoqXG4gKiBQcm9wcyBmb3IgdGhlIElkZW50aXR5UG9vbCBjb25zdHJ1Y3RcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJZGVudGl0eVBvb2xQcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgSWRlbnRpdHkgUG9vbFxuICAgKiBAZGVmYXVsdCAtIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIG5hbWUgYnkgQ2xvdWRGb3JtYXRpb24gYXQgZGVwbG95IHRpbWVcbiAgICovXG4gIHJlYWRvbmx5IGlkZW50aXR5UG9vbE5hbWU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBEZWZhdWx0IFJvbGUgdG8gYmUgYXNzdW1lZCBieSBBdXRoZW50aWNhdGVkIFVzZXJzXG4gICAqIEBkZWZhdWx0IC0gQSBEZWZhdWx0IEF1dGhlbnRpY2F0ZWQgUm9sZSB3aWxsIGJlIGFkZGVkXG4gICAqL1xuICByZWFkb25seSBhdXRoZW50aWNhdGVkUm9sZT86IElSb2xlO1xuXG4gIC8qKlxuICAgKiBUaGUgRGVmYXVsdCBSb2xlIHRvIGJlIGFzc3VtZWQgYnkgVW5hdXRoZW50aWNhdGVkIFVzZXJzXG4gICAqIEBkZWZhdWx0IC0gQSBEZWZhdWx0IFVuYXV0aGVudGljYXRlZCBSb2xlIHdpbGwgYmUgYWRkZWRcbiAgICovXG4gIHJlYWRvbmx5IHVuYXV0aGVudGljYXRlZFJvbGU/OiBJUm9sZTtcblxuICAvKipcbiAgICogV3doZXRoZXIgdGhlIGlkZW50aXR5IHBvb2wgc3VwcG9ydHMgdW5hdXRoZW50aWNhdGVkIGxvZ2luc1xuICAgKiBAZGVmYXVsdCAtIGZhbHNlXG4gICAqL1xuICByZWFkb25seSBhbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXM/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBSdWxlcyBmb3IgbWFwcGluZyByb2xlcyB0byB1c2Vyc1xuICAgKiBAZGVmYXVsdCAtIG5vIFJvbGUgTWFwcGluZ3NcbiAgICovXG4gIHJlYWRvbmx5IHJvbGVNYXBwaW5ncz86IElkZW50aXR5UG9vbFJvbGVNYXBwaW5nW107XG5cbiAgLyoqXG4gICAqIEVuYWJsZXMgdGhlIEJhc2ljIChDbGFzc2ljKSBhdXRoZW50aWNhdGlvbiBmbG93XG4gICAqIEBkZWZhdWx0IC0gQ2xhc3NpYyBGbG93IG5vdCBhbGxvd2VkXG4gICAqL1xuICByZWFkb25seSBhbGxvd0NsYXNzaWNGbG93PzogYm9vbGVhbjtcblxuICAvKipcbiAgICogQXV0aGVudGljYXRpb24gcHJvdmlkZXJzIGZvciB1c2luZyBpbiBpZGVudGl0eSBwb29sLlxuICAgKiBAZGVmYXVsdCAtIE5vIEF1dGhlbnRpY2F0aW9uIFByb3ZpZGVycyBwYXNzZWQgZGlyZWN0bHkgdG8gSWRlbnRpdHkgUG9vbFxuICAgKi9cbiAgcmVhZG9ubHkgYXV0aGVudGljYXRpb25Qcm92aWRlcnM/OiBJZGVudGl0eVBvb2xBdXRoZW50aWNhdGlvblByb3ZpZGVycztcbn1cblxuLyoqXG4gKiBUeXBlcyBvZiBJZGVudGl0eSBQb29sIExvZ2luIFByb3ZpZGVyc1xuICovXG5leHBvcnQgZW51bSBJZGVudGl0eVBvb2xQcm92aWRlclR5cGUge1xuICAvKiogRmFjZWJvb2sgUHJvdmlkZXIgdHlwZSAqL1xuICBGQUNFQk9PSyA9ICdGYWNlYm9vaycsXG4gIC8qKiBHb29nbGUgUHJvdmlkZXIgVHlwZSAqL1xuICBHT09HTEUgPSAnR29vZ2xlJyxcbiAgLyoqIEFtYXpvbiBQcm92aWRlciBUeXBlICovXG4gIEFNQVpPTiA9ICdBbWF6b24nLFxuICAvKiogQXBwbGUgUHJvdmlkZXIgVHlwZSAqL1xuICBBUFBMRSA9ICdBcHBsZScsXG4gIC8qKiBUd2l0dGVyIFByb3ZpZGVyIFR5cGUgKi9cbiAgVFdJVFRFUiA9ICdUd2l0dGVyJyxcbiAgLyoqIERpZ2l0cyBQcm92aWRlciBUeXBlICovXG4gIERJR0lUUyA9ICdEaWdpdHMnLFxuICAvKiogT3BlbiBJZCBQcm92aWRlciBUeXBlICovXG4gIE9QRU5fSUQgPSAnT3BlbklkJyxcbiAgLyoqIFNhbWwgUHJvdmlkZXIgVHlwZSAqL1xuICBTQU1MID0gJ1NhbWwnLFxuICAvKiogVXNlciBQb29sIFByb3ZpZGVyIFR5cGUgKi9cbiAgVVNFUl9QT09MID0gJ1VzZXJQb29sJyxcbiAgLyoqIEN1c3RvbSBQcm92aWRlciBUeXBlICovXG4gIENVU1RPTSA9ICdDdXN0b20nLFxufVxuXG4vKipcbiAqIEtleXMgZm9yIExvZ2luIFByb3ZpZGVycyAtIGNvcnJlc3BvbmQgdG8gY2xpZW50IGlkJ3Mgb2YgcmVzcGVjdGl2ZSBmZWRlcmF0aW9uIGlkZW50aXR5IHByb3ZpZGVyc1xuICovXG5leHBvcnQgY2xhc3MgSWRlbnRpdHlQb29sUHJvdmlkZXJVcmwge1xuICAvKiogRmFjZWJvb2sgUHJvdmlkZXIgVXJsICovXG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgRkFDRUJPT0sgPSBuZXcgSWRlbnRpdHlQb29sUHJvdmlkZXJVcmwoSWRlbnRpdHlQb29sUHJvdmlkZXJUeXBlLkZBQ0VCT09LLCAnZ3JhcGguZmFjZWJvb2suY29tJyk7XG5cbiAgLyoqIEdvb2dsZSBQcm92aWRlciBVcmwgKi9cbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBHT09HTEUgPSBuZXcgSWRlbnRpdHlQb29sUHJvdmlkZXJVcmwoSWRlbnRpdHlQb29sUHJvdmlkZXJUeXBlLkdPT0dMRSwgJ2FjY291bnRzLmdvb2dsZS5jb20nKTtcblxuICAvKiogQW1hem9uIFByb3ZpZGVyIFVybCAqL1xuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IEFNQVpPTiA9IG5ldyBJZGVudGl0eVBvb2xQcm92aWRlclVybChJZGVudGl0eVBvb2xQcm92aWRlclR5cGUuQU1BWk9OLCAnd3d3LmFtYXpvbi5jb20nKTtcblxuICAvKiogQXBwbGUgUHJvdmlkZXIgVXJsICovXG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgQVBQTEUgPSBuZXcgSWRlbnRpdHlQb29sUHJvdmlkZXJVcmwoSWRlbnRpdHlQb29sUHJvdmlkZXJUeXBlLkFQUExFLCAnYXBwbGVpZC5hcHBsZS5jb20nKTtcblxuICAvKiogVHdpdHRlciBQcm92aWRlciBVcmwgKi9cbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBUV0lUVEVSID0gbmV3IElkZW50aXR5UG9vbFByb3ZpZGVyVXJsKElkZW50aXR5UG9vbFByb3ZpZGVyVHlwZS5UV0lUVEVSLCAnYXBpLnR3aXR0ZXIuY29tJyk7XG5cbiAgLyoqIERpZ2l0cyBQcm92aWRlciBVcmwgKi9cbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBESUdJVFMgPSBuZXcgSWRlbnRpdHlQb29sUHJvdmlkZXJVcmwoSWRlbnRpdHlQb29sUHJvdmlkZXJUeXBlLkRJR0lUUywgJ3d3dy5kaWdpdHMuY29tJyk7XG5cbiAgLyoqIE9wZW5JZCBQcm92aWRlciBVcmwgKi9cbiAgcHVibGljIHN0YXRpYyBvcGVuSWQodXJsOiBzdHJpbmcpOiBJZGVudGl0eVBvb2xQcm92aWRlclVybCB7XG4gICAgcmV0dXJuIG5ldyBJZGVudGl0eVBvb2xQcm92aWRlclVybChJZGVudGl0eVBvb2xQcm92aWRlclR5cGUuT1BFTl9JRCwgdXJsKTtcbiAgfVxuXG4gIC8qKiBTYW1sIFByb3ZpZGVyIFVybCAqL1xuICBwdWJsaWMgc3RhdGljIHNhbWwodXJsOiBzdHJpbmcpOiBJZGVudGl0eVBvb2xQcm92aWRlclVybCB7XG4gICAgcmV0dXJuIG5ldyBJZGVudGl0eVBvb2xQcm92aWRlclVybChJZGVudGl0eVBvb2xQcm92aWRlclR5cGUuU0FNTCwgdXJsKTtcbiAgfVxuXG4gIC8qKiBVc2VyIFBvb2wgUHJvdmlkZXIgVXJsICovXG4gIHB1YmxpYyBzdGF0aWMgdXNlclBvb2wodXNlclBvb2w6IFVzZXJQb29sLCB1c2VyUG9vbENsaWVudDogVXNlclBvb2xDbGllbnQpOiBJZGVudGl0eVBvb2xQcm92aWRlclVybCB7XG4gICAgY29uc3QgdXJsID0gYCR7dXNlclBvb2wudXNlclBvb2xQcm92aWRlck5hbWV9OiR7dXNlclBvb2xDbGllbnQudXNlclBvb2xDbGllbnRJZH1gO1xuICAgIHJldHVybiBuZXcgSWRlbnRpdHlQb29sUHJvdmlkZXJVcmwoSWRlbnRpdHlQb29sUHJvdmlkZXJUeXBlLlVTRVJfUE9PTCwgdXJsKTtcbiAgfVxuXG4gIC8qKiBDdXN0b20gUHJvdmlkZXIgVXJsICovXG4gIHB1YmxpYyBzdGF0aWMgY3VzdG9tKHVybDogc3RyaW5nKTogSWRlbnRpdHlQb29sUHJvdmlkZXJVcmwge1xuICAgIHJldHVybiBuZXcgSWRlbnRpdHlQb29sUHJvdmlkZXJVcmwoSWRlbnRpdHlQb29sUHJvdmlkZXJUeXBlLkNVU1RPTSwgdXJsKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIC8qKiB0eXBlIG9mIFByb3ZpZGVyIFVybCAqL1xuICAgIHB1YmxpYyByZWFkb25seSB0eXBlOiBJZGVudGl0eVBvb2xQcm92aWRlclR5cGUsXG4gICAgLyoqIHZhbHVlIG9mIFByb3ZpZGVyIFVybCAqL1xuICAgIHB1YmxpYyByZWFkb25seSB2YWx1ZTogc3RyaW5nLFxuICApIHt9XG59XG5cbi8qKlxuICogTG9naW4gUHJvdmlkZXIgZm9yIElkZW50aXR5IEZlZGVyYXRpb24gdXNpbmcgQW1hem9uIENyZWRlbnRpYWxzXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSWRlbnRpdHlQb29sQW1hem9uTG9naW5Qcm92aWRlciB7XG4gIC8qKlxuICAgKiBBcHAgSWQgZm9yIEFtYXpvbiBJZGVudGl0eSBGZWRlcmF0aW9uXG4gICAqL1xuICByZWFkb25seSBhcHBJZDogc3RyaW5nO1xufVxuXG4vKipcbiAqIExvZ2luIFByb3ZpZGVyIGZvciBJZGVudGl0eSBGZWRlcmF0aW9uIHVzaW5nIEZhY2Vib29rIENyZWRlbnRpYWxzXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSWRlbnRpdHlQb29sRmFjZWJvb2tMb2dpblByb3ZpZGVyIHtcbiAgLyoqXG4gICAqIEFwcCBJZCBmb3IgRmFjZWJvb2sgSWRlbnRpdHkgRmVkZXJhdGlvblxuICAgKi9cbiAgcmVhZG9ubHkgYXBwSWQ6IHN0cmluZztcbn1cblxuLyoqXG4gKiBMb2dpbiBQcm92aWRlciBmb3IgSWRlbnRpdHkgRmVkZXJhdGlvbiB1c2luZyBBcHBsZSBDcmVkZW50aWFsc1xuKi9cbmV4cG9ydCBpbnRlcmZhY2UgSWRlbnRpdHlQb29sQXBwbGVMb2dpblByb3ZpZGVyIHtcbiAgLyoqXG4gICAqIEFwcCBJZCBmb3IgQXBwbGUgSWRlbnRpdHkgRmVkZXJhdGlvblxuICAqL1xuICByZWFkb25seSBzZXJ2aWNlc0lkOiBzdHJpbmc7XG59XG5cbi8qKlxuICogTG9naW4gUHJvdmlkZXIgZm9yIElkZW50aXR5IEZlZGVyYXRpb24gdXNpbmcgR29vZ2xlIENyZWRlbnRpYWxzXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSWRlbnRpdHlQb29sR29vZ2xlTG9naW5Qcm92aWRlciB7XG4gIC8qKlxuICAgKiBBcHAgSWQgZm9yIEdvb2dsZSBJZGVudGl0eSBGZWRlcmF0aW9uXG4gICAqL1xuICByZWFkb25seSBjbGllbnRJZDogc3RyaW5nO1xufVxuXG4vKipcbiAqIExvZ2luIFByb3ZpZGVyIGZvciBJZGVudGl0eSBGZWRlcmF0aW9uIHVzaW5nIFR3aXR0ZXIgQ3JlZGVudGlhbHNcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJZGVudGl0eVBvb2xUd2l0dGVyTG9naW5Qcm92aWRlciB7XG4gIC8qKlxuICAgKiBBcHAgSWQgZm9yIFR3aXR0ZXIgSWRlbnRpdHkgRmVkZXJhdGlvblxuICAgKi9cbiAgcmVhZG9ubHkgY29uc3VtZXJLZXk6IHN0cmluZztcblxuICAvKipcbiAgICogQXBwIFNlY3JldCBmb3IgVHdpdHRlciBJZGVudGl0eSBGZWRlcmF0aW9uXG4gICAqL1xuICByZWFkb25seSBjb25zdW1lclNlY3JldDogc3RyaW5nO1xufVxuXG4vKipcbiAqIExvZ2luIFByb3ZpZGVyIGZvciBJZGVudGl0eSBGZWRlcmF0aW9uIHVzaW5nIERpZ2l0cyBDcmVkZW50aWFsc1xuICovXG5leHBvcnQgaW50ZXJmYWNlIElkZW50aXR5UG9vbERpZ2l0c0xvZ2luUHJvdmlkZXIgZXh0ZW5kcyBJZGVudGl0eVBvb2xUd2l0dGVyTG9naW5Qcm92aWRlciB7fVxuXG4vKipcbiAqIEV4dGVybmFsIElkZW50aXR5IFByb3ZpZGVycyBUbyBDb25uZWN0IHRvIFVzZXIgUG9vbHMgYW5kIElkZW50aXR5IFBvb2xzXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSWRlbnRpdHlQb29sUHJvdmlkZXJzIHtcbiAgLyoqIEFwcCBJZCBmb3IgRmFjZWJvb2sgSWRlbnRpdHkgRmVkZXJhdGlvblxuICAgKiBAZGVmYXVsdCAtIE5vIEZhY2Vib29rIEF1dGhlbnRpY2F0aW9uIFByb3ZpZGVyIHVzZWQgd2l0aG91dCBPcGVuSWRDb25uZWN0IG9yIGEgVXNlciBQb29sXG4gICAqL1xuICByZWFkb25seSBmYWNlYm9vaz86IElkZW50aXR5UG9vbEZhY2Vib29rTG9naW5Qcm92aWRlcjtcblxuICAvKiogQ2xpZW50IElkIGZvciBHb29nbGUgSWRlbnRpdHkgRmVkZXJhdGlvblxuICAgKiBAZGVmYXVsdCAtIE5vIEdvb2dsZSBBdXRoZW50aWNhdGlvbiBQcm92aWRlciB1c2VkIHdpdGhvdXQgT3BlbklkQ29ubmVjdCBvciBhIFVzZXIgUG9vbFxuICAgKi9cbiAgcmVhZG9ubHkgZ29vZ2xlPzogSWRlbnRpdHlQb29sR29vZ2xlTG9naW5Qcm92aWRlcjtcblxuICAvKiogQXBwIElkIGZvciBBbWF6b24gSWRlbnRpdHkgRmVkZXJhdGlvblxuICAgKiBAZGVmYXVsdCAtICBObyBBbWF6b24gQXV0aGVudGljYXRpb24gUHJvdmlkZXIgdXNlZCB3aXRob3V0IE9wZW5JZENvbm5lY3Qgb3IgYSBVc2VyIFBvb2xcbiAgICovXG4gIHJlYWRvbmx5IGFtYXpvbj86IElkZW50aXR5UG9vbEFtYXpvbkxvZ2luUHJvdmlkZXI7XG5cbiAgLyoqIFNlcnZpY2VzIElkIGZvciBBcHBsZSBJZGVudGl0eSBGZWRlcmF0aW9uXG4gICAqIEBkZWZhdWx0IC0gTm8gQXBwbGUgQXV0aGVudGljYXRpb24gUHJvdmlkZXIgdXNlZCB3aXRob3V0IE9wZW5JZENvbm5lY3Qgb3IgYSBVc2VyIFBvb2xcbiAgICovXG4gIHJlYWRvbmx5IGFwcGxlPzogSWRlbnRpdHlQb29sQXBwbGVMb2dpblByb3ZpZGVyO1xuXG4gIC8qKiBDb25zdW1lciBLZXkgYW5kIFNlY3JldCBmb3IgVHdpdHRlciBJZGVudGl0eSBGZWRlcmF0aW9uXG4gICAqIEBkZWZhdWx0IC0gTm8gVHdpdHRlciBBdXRoZW50aWNhdGlvbiBQcm92aWRlciB1c2VkIHdpdGhvdXQgT3BlbklkQ29ubmVjdCBvciBhIFVzZXIgUG9vbFxuICAgKi9cbiAgcmVhZG9ubHkgdHdpdHRlcj86IElkZW50aXR5UG9vbFR3aXR0ZXJMb2dpblByb3ZpZGVyO1xuXG4gIC8qKiBDb25zdW1lciBLZXkgYW5kIFNlY3JldCBmb3IgRGlnaXRzIElkZW50aXR5IEZlZGVyYXRpb25cbiAgICogQGRlZmF1bHQgLSBObyBEaWdpdHMgQXV0aGVudGljYXRpb24gUHJvdmlkZXIgdXNlZCB3aXRob3V0IE9wZW5JZENvbm5lY3Qgb3IgYSBVc2VyIFBvb2xcbiAgICovXG4gIHJlYWRvbmx5IGRpZ2l0cz86IElkZW50aXR5UG9vbERpZ2l0c0xvZ2luUHJvdmlkZXI7XG59XG5cbi8qKlxuKiBBdXRoZW50aWNhdGlvbiBwcm92aWRlcnMgZm9yIHVzaW5nIGluIGlkZW50aXR5IHBvb2wuXG4qIEBzZWUgaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2NvZ25pdG8vbGF0ZXN0L2RldmVsb3Blcmd1aWRlL2V4dGVybmFsLWlkZW50aXR5LXByb3ZpZGVycy5odG1sXG4qL1xuZXhwb3J0IGludGVyZmFjZSBJZGVudGl0eVBvb2xBdXRoZW50aWNhdGlvblByb3ZpZGVycyBleHRlbmRzIElkZW50aXR5UG9vbFByb3ZpZGVycyB7XG4gIC8qKlxuICAgKiBUaGUgVXNlciBQb29sIEF1dGhlbnRpY2F0aW9uIFByb3ZpZGVycyBhc3NvY2lhdGVkIHdpdGggdGhpcyBJZGVudGl0eSBQb29sXG4gICAqIEBkZWZhdWx0IC0gbm8gVXNlciBQb29scyBBc3NvY2lhdGVkXG4gICAqL1xuICByZWFkb25seSB1c2VyUG9vbHM/OiBJVXNlclBvb2xBdXRoZW50aWNhdGlvblByb3ZpZGVyW107XG5cbiAgLyoqXG4gICAqIFRoZSBPcGVuSWRDb25uZWN0IFByb3ZpZGVyIGFzc29jaWF0ZWQgd2l0aCB0aGlzIElkZW50aXR5IFBvb2xcbiAgICogQGRlZmF1bHQgLSBubyBPcGVuSWRDb25uZWN0UHJvdmlkZXJcbiAgKi9cbiAgcmVhZG9ubHkgb3BlbklkQ29ubmVjdFByb3ZpZGVycz86IElPcGVuSWRDb25uZWN0UHJvdmlkZXJbXTtcblxuICAvKipcbiAgICogVGhlIFNlY3VyaXR5IEFzc2VydGlvbiBNYXJrdXAgTGFuZ3VhZ2UgUHJvdmlkZXIgYXNzb2NpYXRlZCB3aXRoIHRoaXMgSWRlbnRpdHkgUG9vbFxuICAgKiBAZGVmYXVsdCAtIG5vIFNhbWxQcm92aWRlclxuICAqL1xuICByZWFkb25seSBzYW1sUHJvdmlkZXJzPzogSVNhbWxQcm92aWRlcltdO1xuXG4gIC8qKlxuICAgKiBUaGUgRGV2ZWxvcGVyIFByb3ZpZGVyIE5hbWUgdG8gYXNzb2NpYXRlIHdpdGggdGhpcyBJZGVudGl0eSBQb29sXG4gICAqIEBkZWZhdWx0IC0gbm8gQ3VzdG9tIFByb3ZpZGVyXG4gICovXG4gIHJlYWRvbmx5IGN1c3RvbVByb3ZpZGVyPzogc3RyaW5nO1xufVxuXG4vKipcbiAqIERlZmluZSBhIENvZ25pdG8gSWRlbnRpdHkgUG9vbFxuICpcbiAqICBAcmVzb3VyY2UgQVdTOjpDb2duaXRvOjpJZGVudGl0eVBvb2xcbiAqL1xuZXhwb3J0IGNsYXNzIElkZW50aXR5UG9vbCBleHRlbmRzIFJlc291cmNlIGltcGxlbWVudHMgSUlkZW50aXR5UG9vbCB7XG4gIC8qKlxuICAgKiBJbXBvcnQgYW4gZXhpc3RpbmcgSWRlbnRpdHkgUG9vbCBmcm9tIGl0cyBpZFxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBmcm9tSWRlbnRpdHlQb29sSWQoc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgaWRlbnRpdHlQb29sSWQ6IHN0cmluZyk6IElJZGVudGl0eVBvb2wge1xuICAgIGNvbnN0IGlkZW50aXR5UG9vbEFybiA9IFN0YWNrLm9mKHNjb3BlKS5mb3JtYXRBcm4oe1xuICAgICAgc2VydmljZTogJ2NvZ25pdG8taWRlbnRpdHknLFxuICAgICAgcmVzb3VyY2U6ICdpZGVudGl0eXBvb2wnLFxuICAgICAgcmVzb3VyY2VOYW1lOiBpZGVudGl0eVBvb2xJZCxcbiAgICAgIGFybkZvcm1hdDogQXJuRm9ybWF0LlNMQVNIX1JFU09VUkNFX05BTUUsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gSWRlbnRpdHlQb29sLmZyb21JZGVudGl0eVBvb2xBcm4oc2NvcGUsIGlkLCBpZGVudGl0eVBvb2xBcm4pO1xuICB9XG5cbiAgLyoqXG4gICAqIEltcG9ydCBhbiBleGlzdGluZyBJZGVudGl0eSBQb29sIGZyb20gaXRzIEFyblxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBmcm9tSWRlbnRpdHlQb29sQXJuKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIGlkZW50aXR5UG9vbEFybjogc3RyaW5nKTogSUlkZW50aXR5UG9vbCB7XG4gICAgY29uc3QgcG9vbCA9IFN0YWNrLm9mKHNjb3BlKS5zcGxpdEFybihpZGVudGl0eVBvb2xBcm4sIEFybkZvcm1hdC5TTEFTSF9SRVNPVVJDRV9OQU1FKTtcbiAgICBjb25zdCByZXMgPSBwb29sLnJlc291cmNlTmFtZSB8fCAnJztcbiAgICBpZiAoIXJlcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIElkZW50aXR5IFBvb2wgQVJOJyk7XG4gICAgfVxuICAgIGlmICghVG9rZW4uaXNVbnJlc29sdmVkKHJlcykpIHtcbiAgICAgIGNvbnN0IGlkUGFydHMgPSByZXMuc3BsaXQoJzonKTtcbiAgICAgIGlmICghKGlkUGFydHMubGVuZ3RoID09PSAyKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgSWRlbnRpdHkgUG9vbCBJZDogSWRlbnRpdHkgUG9vbCBJZHMgbXVzdCBmb2xsb3cgdGhlIGZvcm1hdCA8cmVnaW9uPjo8aWQ+Jyk7XG4gICAgICB9XG4gICAgICBpZiAoIVRva2VuLmlzVW5yZXNvbHZlZChwb29sLnJlZ2lvbikgJiYgaWRQYXJ0c1swXSAhPT0gcG9vbC5yZWdpb24pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIElkZW50aXR5IFBvb2wgSWQ6IFJlZ2lvbiBpbiBJZGVudGl0eSBQb29sIElkIG11c3QgbWF0Y2ggc3RhY2sgcmVnaW9uJyk7XG4gICAgICB9XG4gICAgfVxuICAgIGNsYXNzIEltcG9ydGVkSWRlbnRpdHlQb29sIGV4dGVuZHMgUmVzb3VyY2UgaW1wbGVtZW50cyBJSWRlbnRpdHlQb29sIHtcbiAgICAgIHB1YmxpYyByZWFkb25seSBpZGVudGl0eVBvb2xJZCA9IHJlcztcbiAgICAgIHB1YmxpYyByZWFkb25seSBpZGVudGl0eVBvb2xBcm4gPSBpZGVudGl0eVBvb2xBcm47XG4gICAgICBwdWJsaWMgcmVhZG9ubHkgaWRlbnRpdHlQb29sTmFtZTogc3RyaW5nXG4gICAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsIGlkLCB7XG4gICAgICAgICAgYWNjb3VudDogcG9vbC5hY2NvdW50LFxuICAgICAgICAgIHJlZ2lvbjogcG9vbC5yZWdpb24sXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmlkZW50aXR5UG9vbE5hbWUgPSB0aGlzLnBoeXNpY2FsTmFtZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG5ldyBJbXBvcnRlZElkZW50aXR5UG9vbCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBpZCBvZiB0aGUgSWRlbnRpdHkgUG9vbCBpbiB0aGUgZm9ybWF0IFJFR0lPTjpHVUlEXG4gICAqIEBhdHRyaWJ1dGVcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBpZGVudGl0eVBvb2xJZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgQVJOIG9mIHRoZSBJZGVudGl0eSBQb29sXG4gICAqIEBhdHRyaWJ1dGVcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBpZGVudGl0eVBvb2xBcm46IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIElkZW50aXR5IFBvb2xcbiAgICogQGF0dHJpYnV0ZVxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGlkZW50aXR5UG9vbE5hbWU6IHN0cmluZztcblxuICAvKipcbiAgICogRGVmYXVsdCByb2xlIGZvciBhdXRoZW50aWNhdGVkIHVzZXJzXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgYXV0aGVudGljYXRlZFJvbGU6IElSb2xlO1xuXG4gIC8qKlxuICAgICogRGVmYXVsdCByb2xlIGZvciB1bmF1dGhlbnRpY2F0ZWQgdXNlcnNcbiAgICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgdW5hdXRoZW50aWNhdGVkUm9sZTogSVJvbGU7XG5cbiAgLyoqXG4gICAqIExpc3Qgb2YgSWRlbnRpdHkgUHJvdmlkZXJzIGFkZGVkIGluIGNvbnN0cnVjdG9yIGZvciB1c2Ugd2l0aCBwcm9wZXJ0eSBvdmVycmlkZXNcbiAgICovXG4gIHByaXZhdGUgY29nbml0b0lkZW50aXR5UHJvdmlkZXJzOiBDZm5JZGVudGl0eVBvb2wuQ29nbml0b0lkZW50aXR5UHJvdmlkZXJQcm9wZXJ0eVtdID0gW107XG5cbiAgLyoqXG4gICAqIFJ1bm5pbmcgY291bnQgb2YgYWRkZWQgcm9sZSBhdHRhY2htZW50c1xuICAgKi9cbiAgcHJpdmF0ZSByb2xlQXR0YWNobWVudENvdW50OiBudW1iZXIgPSAwO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOklkZW50aXR5UG9vbFByb3BzID0ge30pIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHtcbiAgICAgIHBoeXNpY2FsTmFtZTogcHJvcHMuaWRlbnRpdHlQb29sTmFtZSxcbiAgICB9KTtcbiAgICBjb25zdCBhdXRoUHJvdmlkZXJzOiBJZGVudGl0eVBvb2xBdXRoZW50aWNhdGlvblByb3ZpZGVycyA9IHByb3BzLmF1dGhlbnRpY2F0aW9uUHJvdmlkZXJzIHx8IHt9O1xuICAgIGNvbnN0IHByb3ZpZGVycyA9IGF1dGhQcm92aWRlcnMudXNlclBvb2xzID8gYXV0aFByb3ZpZGVycy51c2VyUG9vbHMubWFwKHVzZXJQb29sID0+IHVzZXJQb29sLmJpbmQodGhpcywgdGhpcykpIDogdW5kZWZpbmVkO1xuICAgIGlmIChwcm92aWRlcnMgJiYgcHJvdmlkZXJzLmxlbmd0aCkgdGhpcy5jb2duaXRvSWRlbnRpdHlQcm92aWRlcnMgPSBwcm92aWRlcnM7XG4gICAgY29uc3Qgb3BlbklkQ29ubmVjdFByb3ZpZGVyQXJucyA9IGF1dGhQcm92aWRlcnMub3BlbklkQ29ubmVjdFByb3ZpZGVycyA/XG4gICAgICBhdXRoUHJvdmlkZXJzLm9wZW5JZENvbm5lY3RQcm92aWRlcnMubWFwKG9wZW5JZFByb3ZpZGVyID0+XG4gICAgICAgIG9wZW5JZFByb3ZpZGVyLm9wZW5JZENvbm5lY3RQcm92aWRlckFybixcbiAgICAgICkgOiB1bmRlZmluZWQ7XG4gICAgY29uc3Qgc2FtbFByb3ZpZGVyQXJucyA9IGF1dGhQcm92aWRlcnMuc2FtbFByb3ZpZGVycyA/XG4gICAgICBhdXRoUHJvdmlkZXJzLnNhbWxQcm92aWRlcnMubWFwKHNhbWxQcm92aWRlciA9PlxuICAgICAgICBzYW1sUHJvdmlkZXIuc2FtbFByb3ZpZGVyQXJuLFxuICAgICAgKSA6IHVuZGVmaW5lZDtcblxuICAgIGxldCBzdXBwb3J0ZWRMb2dpblByb3ZpZGVyczphbnkgPSB7fTtcbiAgICBpZiAoYXV0aFByb3ZpZGVycy5hbWF6b24pIHN1cHBvcnRlZExvZ2luUHJvdmlkZXJzW0lkZW50aXR5UG9vbFByb3ZpZGVyVXJsLkFNQVpPTi52YWx1ZV0gPSBhdXRoUHJvdmlkZXJzLmFtYXpvbi5hcHBJZDtcbiAgICBpZiAoYXV0aFByb3ZpZGVycy5mYWNlYm9vaykgc3VwcG9ydGVkTG9naW5Qcm92aWRlcnNbSWRlbnRpdHlQb29sUHJvdmlkZXJVcmwuRkFDRUJPT0sudmFsdWVdID0gYXV0aFByb3ZpZGVycy5mYWNlYm9vay5hcHBJZDtcbiAgICBpZiAoYXV0aFByb3ZpZGVycy5nb29nbGUpIHN1cHBvcnRlZExvZ2luUHJvdmlkZXJzW0lkZW50aXR5UG9vbFByb3ZpZGVyVXJsLkdPT0dMRS52YWx1ZV0gPSBhdXRoUHJvdmlkZXJzLmdvb2dsZS5jbGllbnRJZDtcbiAgICBpZiAoYXV0aFByb3ZpZGVycy5hcHBsZSkgc3VwcG9ydGVkTG9naW5Qcm92aWRlcnNbSWRlbnRpdHlQb29sUHJvdmlkZXJVcmwuQVBQTEUudmFsdWVdID0gYXV0aFByb3ZpZGVycy5hcHBsZS5zZXJ2aWNlc0lkO1xuICAgIGlmIChhdXRoUHJvdmlkZXJzLnR3aXR0ZXIpIHN1cHBvcnRlZExvZ2luUHJvdmlkZXJzW0lkZW50aXR5UG9vbFByb3ZpZGVyVXJsLlRXSVRURVIudmFsdWVdID0gYCR7YXV0aFByb3ZpZGVycy50d2l0dGVyLmNvbnN1bWVyS2V5fTske2F1dGhQcm92aWRlcnMudHdpdHRlci5jb25zdW1lclNlY3JldH1gO1xuICAgIGlmIChhdXRoUHJvdmlkZXJzLmRpZ2l0cykgc3VwcG9ydGVkTG9naW5Qcm92aWRlcnNbSWRlbnRpdHlQb29sUHJvdmlkZXJVcmwuRElHSVRTLnZhbHVlXSA9IGAke2F1dGhQcm92aWRlcnMuZGlnaXRzLmNvbnN1bWVyS2V5fTske2F1dGhQcm92aWRlcnMuZGlnaXRzLmNvbnN1bWVyU2VjcmV0fWA7XG4gICAgaWYgKCFPYmplY3Qua2V5cyhzdXBwb3J0ZWRMb2dpblByb3ZpZGVycykubGVuZ3RoKSBzdXBwb3J0ZWRMb2dpblByb3ZpZGVycyA9IHVuZGVmaW5lZDtcblxuICAgIGNvbnN0IGNmbklkZW50aXR5UG9vbCA9IG5ldyBDZm5JZGVudGl0eVBvb2wodGhpcywgJ1Jlc291cmNlJywge1xuICAgICAgYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzOiBwcm9wcy5hbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMgPyB0cnVlIDogZmFsc2UsXG4gICAgICBhbGxvd0NsYXNzaWNGbG93OiBwcm9wcy5hbGxvd0NsYXNzaWNGbG93LFxuICAgICAgaWRlbnRpdHlQb29sTmFtZTogdGhpcy5waHlzaWNhbE5hbWUsXG4gICAgICBkZXZlbG9wZXJQcm92aWRlck5hbWU6IGF1dGhQcm92aWRlcnMuY3VzdG9tUHJvdmlkZXIsXG4gICAgICBvcGVuSWRDb25uZWN0UHJvdmlkZXJBcm5zLFxuICAgICAgc2FtbFByb3ZpZGVyQXJucyxcbiAgICAgIHN1cHBvcnRlZExvZ2luUHJvdmlkZXJzLFxuICAgICAgY29nbml0b0lkZW50aXR5UHJvdmlkZXJzOiBMYXp5LmFueSh7IHByb2R1Y2U6ICgpID0+IHRoaXMuY29nbml0b0lkZW50aXR5UHJvdmlkZXJzIH0pLFxuICAgIH0pO1xuICAgIHRoaXMuaWRlbnRpdHlQb29sTmFtZSA9IGNmbklkZW50aXR5UG9vbC5hdHRyTmFtZTtcbiAgICB0aGlzLmlkZW50aXR5UG9vbElkID0gY2ZuSWRlbnRpdHlQb29sLnJlZjtcbiAgICB0aGlzLmlkZW50aXR5UG9vbEFybiA9IFN0YWNrLm9mKHNjb3BlKS5mb3JtYXRBcm4oe1xuICAgICAgc2VydmljZTogJ2NvZ25pdG8taWRlbnRpdHknLFxuICAgICAgcmVzb3VyY2U6ICdpZGVudGl0eXBvb2wnLFxuICAgICAgcmVzb3VyY2VOYW1lOiB0aGlzLmlkZW50aXR5UG9vbElkLFxuICAgICAgYXJuRm9ybWF0OiBBcm5Gb3JtYXQuU0xBU0hfUkVTT1VSQ0VfTkFNRSxcbiAgICB9KTtcbiAgICB0aGlzLmF1dGhlbnRpY2F0ZWRSb2xlID0gcHJvcHMuYXV0aGVudGljYXRlZFJvbGUgPyBwcm9wcy5hdXRoZW50aWNhdGVkUm9sZSA6IHRoaXMuY29uZmlndXJlRGVmYXVsdFJvbGUoJ0F1dGhlbnRpY2F0ZWQnKTtcbiAgICB0aGlzLnVuYXV0aGVudGljYXRlZFJvbGUgPSBwcm9wcy51bmF1dGhlbnRpY2F0ZWRSb2xlID8gcHJvcHMudW5hdXRoZW50aWNhdGVkUm9sZSA6IHRoaXMuY29uZmlndXJlRGVmYXVsdFJvbGUoJ1VuYXV0aGVudGljYXRlZCcpO1xuICAgIGNvbnN0IGF0dGFjaG1lbnQgPSBuZXcgSWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQodGhpcywgJ0RlZmF1bHRSb2xlQXR0YWNobWVudCcsIHtcbiAgICAgIGlkZW50aXR5UG9vbDogdGhpcyxcbiAgICAgIGF1dGhlbnRpY2F0ZWRSb2xlOiB0aGlzLmF1dGhlbnRpY2F0ZWRSb2xlLFxuICAgICAgdW5hdXRoZW50aWNhdGVkUm9sZTogdGhpcy51bmF1dGhlbnRpY2F0ZWRSb2xlLFxuICAgICAgcm9sZU1hcHBpbmdzOiBwcm9wcy5yb2xlTWFwcGluZ3MsXG4gICAgfSk7XG5cbiAgICAvLyBUaGlzIGFkZGVkIGJ5IHRoZSBvcmlnaW5hbCBhdXRob3IsIGJ1dCBpdCdzIGNhdXNpbmcgY3ljbGljIGRlcGVuZGVuY2llcy5cbiAgICAvLyBEb24ndCBrbm93IHdoeSB0aGlzIHdhcyBhZGRlZCBpbiB0aGUgZmlyc3QgcGxhY2UsIGJ1dCBJJ20gZGlzYWJsaW5nIGl0IGZvciBub3cgYW5kIGlmXG4gICAgLy8gbm8gY29tcGxhaW50cyBjb21lIGZyb20gdGhpcywgd2UncmUgcHJvYmFibHkgc2FmZSB0byByZW1vdmUgaXQgYWx0b2dldGhlci5cbiAgICAvLyBhdHRhY2htZW50Lm5vZGUuYWRkRGVwZW5kZW5jeSh0aGlzKTtcbiAgICBBcnJheS5pc0FycmF5KGF0dGFjaG1lbnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIFVzZXIgUG9vbCB0byB0aGUgSWRlbnRpdHlQb29sIGFuZCBjb25maWd1cmUgVXNlciBQb29sIENsaWVudCB0byBoYW5kbGUgaWRlbnRpdGllc1xuICAgKi9cbiAgcHVibGljIGFkZFVzZXJQb29sQXV0aGVudGljYXRpb24odXNlclBvb2w6IElVc2VyUG9vbEF1dGhlbnRpY2F0aW9uUHJvdmlkZXIpOiB2b2lkIHtcbiAgICBjb25zdCBwcm92aWRlcnMgPSB1c2VyUG9vbC5iaW5kKHRoaXMsIHRoaXMpO1xuICAgIHRoaXMuY29nbml0b0lkZW50aXR5UHJvdmlkZXJzID0gdGhpcy5jb2duaXRvSWRlbnRpdHlQcm92aWRlcnMuY29uY2F0KHByb3ZpZGVycyk7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBSb2xlIE1hcHBpbmdzIHRvIElkZW50aXR5IFBvb2xcbiAgKi9cbiAgcHVibGljIGFkZFJvbGVNYXBwaW5ncyguLi5yb2xlTWFwcGluZ3M6IElkZW50aXR5UG9vbFJvbGVNYXBwaW5nW10pOiB2b2lkIHtcbiAgICBpZiAoIXJvbGVNYXBwaW5ncyB8fCAhcm9sZU1hcHBpbmdzLmxlbmd0aCkgcmV0dXJuO1xuICAgIHRoaXMucm9sZUF0dGFjaG1lbnRDb3VudCsrO1xuICAgIGNvbnN0IG5hbWUgPSAnUm9sZU1hcHBpbmdBdHRhY2htZW50JyArIHRoaXMucm9sZUF0dGFjaG1lbnRDb3VudC50b1N0cmluZygpO1xuICAgIGNvbnN0IGF0dGFjaG1lbnQgPSBuZXcgSWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQodGhpcywgbmFtZSwge1xuICAgICAgaWRlbnRpdHlQb29sOiB0aGlzLFxuICAgICAgYXV0aGVudGljYXRlZFJvbGU6IHRoaXMuYXV0aGVudGljYXRlZFJvbGUsXG4gICAgICB1bmF1dGhlbnRpY2F0ZWRSb2xlOiB0aGlzLnVuYXV0aGVudGljYXRlZFJvbGUsXG4gICAgICByb2xlTWFwcGluZ3MsXG4gICAgfSk7XG5cbiAgICAvLyBUaGlzIGFkZGVkIGJ5IHRoZSBvcmlnaW5hbCBhdXRob3IsIGJ1dCBpdCdzIGNhdXNpbmcgY3ljbGljIGRlcGVuZGVuY2llcy5cbiAgICAvLyBEb24ndCBrbm93IHdoeSB0aGlzIHdhcyBhZGRlZCBpbiB0aGUgZmlyc3QgcGxhY2UsIGJ1dCBJJ20gZGlzYWJsaW5nIGl0IGZvciBub3cgYW5kIGlmXG4gICAgLy8gbm8gY29tcGxhaW50cyBjb21lIGZyb20gdGhpcywgd2UncmUgcHJvYmFibHkgc2FmZSB0byByZW1vdmUgaXQgYWx0b2dldGhlci5cbiAgICAvLyBhdHRhY2htZW50Lm5vZGUuYWRkRGVwZW5kZW5jeSh0aGlzKTtcbiAgICBBcnJheS5pc0FycmF5KGF0dGFjaG1lbnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbmZpZ3VyZSBEZWZhdWx0IFJvbGVzIEZvciBJZGVudGl0eSBQb29sXG4gICAqL1xuICBwcml2YXRlIGNvbmZpZ3VyZURlZmF1bHRSb2xlKHR5cGU6IHN0cmluZyk6IElSb2xlIHtcbiAgICBjb25zdCBhc3N1bWVkQnkgPSB0aGlzLmNvbmZpZ3VyZURlZmF1bHRHcmFudFByaW5jaXBhbCh0eXBlLnRvTG93ZXJDYXNlKCkpO1xuICAgIGNvbnN0IHJvbGUgPSBuZXcgUm9sZSh0aGlzLCBgJHt0eXBlfVJvbGVgLCB7XG4gICAgICBkZXNjcmlwdGlvbjogYERlZmF1bHQgJHt0eXBlfSBSb2xlIGZvciBJZGVudGl0eSBQb29sICR7dGhpcy5pZGVudGl0eVBvb2xOYW1lfWAsXG4gICAgICBhc3N1bWVkQnksXG4gICAgfSk7XG5cbiAgICByZXR1cm4gcm9sZTtcbiAgfVxuXG4gIHByaXZhdGUgY29uZmlndXJlRGVmYXVsdEdyYW50UHJpbmNpcGFsKHR5cGU6IHN0cmluZykge1xuICAgIHJldHVybiBuZXcgRmVkZXJhdGVkUHJpbmNpcGFsKCdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb20nLCB7XG4gICAgICAnU3RyaW5nRXF1YWxzJzoge1xuICAgICAgICAnY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmF1ZCc6IHRoaXMuaWRlbnRpdHlQb29sSWQsXG4gICAgICB9LFxuICAgICAgJ0ZvckFueVZhbHVlOlN0cmluZ0xpa2UnOiB7XG4gICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YW1yJzogdHlwZSxcbiAgICAgIH0sXG4gICAgfSwgJ3N0czpBc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5Jyk7XG4gIH1cbn1cbiJdfQ==