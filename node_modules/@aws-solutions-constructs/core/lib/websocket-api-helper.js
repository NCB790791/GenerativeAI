"use strict";
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildWebSocketQueueApi = buildWebSocketQueueApi;
exports.buildWebSocketApiProps = buildWebSocketApiProps;
exports.buildWebSocketQueueRouteOptions = buildWebSocketQueueRouteOptions;
const cdk = require("aws-cdk-lib");
const apigateway = require("aws-cdk-lib/aws-apigateway");
const apigwv2 = require("aws-cdk-lib/aws-apigatewayv2");
const aws_apigatewayv2_integrations_1 = require("aws-cdk-lib/aws-apigatewayv2-integrations");
const iam = require("aws-cdk-lib/aws-iam");
const cloudwatch_log_group_helper_1 = require("./cloudwatch-log-group-helper");
const utils_1 = require("./utils");
const websocket_api_defaults_1 = require("./websocket-api-defaults");
/**
 * Builds an AWS API Gateway WebSocket API integrated with an Amazon SQS queue.
 *
 * @param scope The construct scope where the resources will be created.
 * @param id The unique ID for the resources.
 * @param props The configuration properties for the WebSocket API and SQS queue integration.
 * @returns
 */
function buildWebSocketQueueApi(scope, id, props) {
    // Setup the API Gateway role
    const apiGatewayRole = new iam.Role(scope, "LambdaRestApiCloudWatchRole", {
        assumedBy: new iam.ServicePrincipal("apigateway.amazonaws.com"),
    });
    props.queue.grantSendMessages(apiGatewayRole);
    const finalProps = (0, utils_1.consolidateProps)(buildWebSocketApiProps(apiGatewayRole, props.queue, props.createDefaultRoute, props.defaultRouteRequestTemplate, props.defaultIamAuthorization), props.webSocketApiProps);
    const webSocketApi = buildApiGatewayV2WebSocket(scope, id, {
        webSocketApiProps: finalProps,
        existingWebSocketApi: props.existingWebSocketApi,
    });
    if (props.customRouteName) {
        webSocketApi.addRoute(props.customRouteName, buildWebSocketQueueRouteOptions(apiGatewayRole, props.queue, props.customRouteName, props.defaultRouteRequestTemplate));
    }
    if (props.existingWebSocketApi === undefined &&
        props.defaultIamAuthorization === false &&
        finalProps.connectRouteOptions?.authorizer === undefined) {
        (0, utils_1.printWarning)("This construct will create a WebSocket with NO Authorizer (defaultIamAuthorization is set to false).");
    }
    const webSocketStage = new apigwv2.WebSocketStage(scope, "Stage", {
        stageName: "prod",
        webSocketApi,
        autoDeploy: true,
    });
    (0, utils_1.addCfnGuardSuppressRules)(webSocketStage, ["API_GW_CACHE_ENABLED_AND_ENCRYPTED"]);
    const apiGatewayLogGroup = (0, cloudwatch_log_group_helper_1.buildLogGroup)(scope, "LogGroup", props.logGroupProps);
    apiGatewayLogGroup.grant(apiGatewayRole, "logs:CreateLogGroup", "logs:CreateLogStream", "logs:DescribeLogGroups", "logs:DescribeLogStreams", "logs:PutLogEvents", "logs:GetLogEvents", "logs:FilterLogEvents");
    const cfnStage = webSocketStage.node.defaultChild;
    cfnStage.addPropertyOverride("AccessLogSettings", {
        DestinationArn: apiGatewayLogGroup.logGroupArn,
        Format: apigateway.AccessLogFormat.clf().toString(),
    });
    cfnStage.addPropertyOverride("DefaultRouteSettings", {
        DataTraceEnabled: false,
        DetailedMetricsEnabled: true,
        LoggingLevel: "ERROR",
    });
    (0, utils_1.addCfnSuppressRules)(webSocketStage, [
        {
            id: "AwsSolutions-APIG1",
            reason: "Access logging configuration has been provided as per ApiGateway v2 requirements",
        },
    ]);
    (0, utils_1.addCfnSuppressRules)(apiGatewayRole.node.tryFindChild("DefaultPolicy")?.node.tryFindChild("Resource"), [
        {
            id: "AwsSolutions-IAM5",
            reason: "The APIGateway requires permissions to KMS so that it can write to an encrypted SQS queue",
        },
    ]);
    return {
        webSocketApi,
        webSocketStage,
        apiGatewayRole,
        apiGatewayLogGroup,
    };
}
/**
 * build ApiGateway v2 WebSocket L2 construct. If existing WebSocketApi instance is provided, it returns that instance,
 * if not, it creates a new WebSocketApi using the user provided props.
 *
 * @param scope
 * @param props
 * @returns
 */
function buildApiGatewayV2WebSocket(scope, id, props) {
    if (props.existingWebSocketApi) {
        return props.existingWebSocketApi;
    }
    else {
        return new apigwv2.WebSocketApi(scope, `WebSocketApi${id}`, props.webSocketApiProps);
    }
}
/**
 * @internal This is an internal core function and should not be called directly by Solutions Constructs clients.
 */
function buildWebSocketApiProps(role, sqsQueue, createDefaultRoute, requestTemplate, defaultIamAuthorization) {
    if (createDefaultRoute) {
        if (!role || !sqsQueue) {
            throw new Error("role and sqs must be provided to create a default route");
        }
    }
    // prettier-ignore
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    // Sonar exception reason: - typescript:S6571 - required because we are not passing all values. Using partial may cause @jsii to not work.
    const websocketApiProps = {
        defaultRouteOptions: createDefaultRoute ? buildWebSocketQueueRouteOptions(role, sqsQueue, '$default', requestTemplate) : undefined,
        connectRouteOptions: (defaultIamAuthorization === undefined || defaultIamAuthorization === true) ? websocket_api_defaults_1.connectRouteOptions : undefined
    };
    return websocketApiProps;
}
/**
 * @internal This is an internal core function and should not be called directly by Solutions Constructs clients.
 */
function buildWebSocketQueueRouteOptions(role, sqsQueue, routeName, requestTemplate) {
    return {
        integration: new aws_apigatewayv2_integrations_1.WebSocketAwsIntegration(routeName, {
            integrationMethod: apigwv2.HttpMethod.POST,
            integrationUri: `arn:${cdk.Aws.PARTITION}:apigateway:${cdk.Aws.REGION}:sqs:path/${cdk.Aws.ACCOUNT_ID}/${sqsQueue.queueName}`,
            requestTemplates: requestTemplate ?? {
                [routeName === "$default" ? "$default" : routeName]: websocket_api_defaults_1.DEFAULT_ROUTE_QUEUE_VTL_CONFIG,
            },
            templateSelectionExpression: routeName === "$default" ? "\\$default" : routeName,
            passthroughBehavior: apigwv2.PassthroughBehavior.NEVER,
            credentialsRole: role,
            requestParameters: {
                "integration.request.header.Content-Type": "'application/x-www-form-urlencoded'",
            },
        }),
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2Vic29ja2V0LWFwaS1oZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ3ZWJzb2NrZXQtYXBpLWhlbHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7O0FBbURILHdEQWdHQztBQXFCRCx3REFxQkM7QUFLRCwwRUFxQkM7QUFyTkQsbUNBQW1DO0FBQ25DLHlEQUF5RDtBQUN6RCx3REFBd0Q7QUFDeEQsNkZBQW9GO0FBQ3BGLDJDQUEyQztBQUkzQywrRUFBOEQ7QUFDOUQsbUNBQXdHO0FBQ3hHLHFFQUErRjtBQStCL0Y7Ozs7Ozs7R0FPRztBQUNILFNBQWdCLHNCQUFzQixDQUNwQyxLQUFnQixFQUNoQixFQUFVLEVBQ1YsS0FBb0M7SUFFcEMsNkJBQTZCO0lBQzdCLE1BQU0sY0FBYyxHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsNkJBQTZCLEVBQUU7UUFDeEUsU0FBUyxFQUFFLElBQUksR0FBRyxDQUFDLGdCQUFnQixDQUFDLDBCQUEwQixDQUFDO0tBQ2hFLENBQUMsQ0FBQztJQUNILEtBQUssQ0FBQyxLQUFLLENBQUMsaUJBQWlCLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDOUMsTUFBTSxVQUFVLEdBQUcsSUFBQSx3QkFBZ0IsRUFDakMsc0JBQXNCLENBQ3BCLGNBQWMsRUFDZCxLQUFLLENBQUMsS0FBSyxFQUNYLEtBQUssQ0FBQyxrQkFBa0IsRUFDeEIsS0FBSyxDQUFDLDJCQUEyQixFQUNqQyxLQUFLLENBQUMsdUJBQXVCLENBQzlCLEVBQ0QsS0FBSyxDQUFDLGlCQUFpQixDQUNLLENBQUM7SUFDL0IsTUFBTSxZQUFZLEdBQUcsMEJBQTBCLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRTtRQUN6RCxpQkFBaUIsRUFBRSxVQUFVO1FBQzdCLG9CQUFvQixFQUFFLEtBQUssQ0FBQyxvQkFBb0I7S0FDakQsQ0FBQyxDQUFDO0lBRUgsSUFBSSxLQUFLLENBQUMsZUFBZSxFQUFF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LENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLFNBQVM7WUFDaEYsbUJBQW1CLEVBQUUsT0FBTyxDQUFDLG1CQUFtQixDQUFDLEtBQUs7WUFDdEQsZUFBZSxFQUFFLElBQUk7WUFDckIsaUJBQWlCLEVBQUU7Z0JBQ2pCLHlDQUF5QyxFQUFFLHFDQUFxQzthQUNqRjtTQUNGLENBQUM7S0FDSCxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4gKiAgd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqICBvciBpbiB0aGUgJ2xpY2Vuc2UnIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICdBUyBJUycgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFU1xuICogIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zXG4gKiAgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCAqIGFzIGNkayBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCAqIGFzIGFwaWdhdGV3YXkgZnJvbSBcImF3cy1jZGstbGliL2F3cy1hcGlnYXRld2F5XCI7XG5pbXBvcnQgKiBhcyBhcGlnd3YyIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtYXBpZ2F0ZXdheXYyXCI7XG5pbXBvcnQgeyBXZWJTb2NrZXRBd3NJbnRlZ3JhdGlvbiB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtYXBpZ2F0ZXdheXYyLWludGVncmF0aW9uc1wiO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtaWFtXCI7XG5pbXBvcnQgKiBhcyBsb2dzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbG9nc1wiO1xuaW1wb3J0ICogYXMgc3FzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtc3FzXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHsgYnVpbGRMb2dHcm91cCB9IGZyb20gXCIuL2Nsb3Vkd2F0Y2gtbG9nLWdyb3VwLWhlbHBlclwiO1xuaW1wb3J0IHsgYWRkQ2ZuR3VhcmRTdXBwcmVzc1J1bGVzLCBhZGRDZm5TdXBwcmVzc1J1bGVzLCBjb25zb2xpZGF0ZVByb3BzLCBwcmludFdhcm5pbmcgfSBmcm9tIFwiLi91dGlsc1wiO1xuaW1wb3J0IHsgY29ubmVjdFJvdXRlT3B0aW9ucywgREVGQVVMVF9ST1VURV9RVUVVRV9WVExfQ09ORklHIH0gZnJvbSBcIi4vd2Vic29ja2V0LWFwaS1kZWZhdWx0c1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIEJ1aWxkV2ViU29ja2V0UXVldWVBcGlSZXNwb25zZSB7XG4gIHJlYWRvbmx5IHdlYlNvY2tldEFwaTogYXBpZ3d2Mi5XZWJTb2NrZXRBcGk7XG4gIHJlYWRvbmx5IHdlYlNvY2tldFN0YWdlOiBhcGlnd3YyLldlYlNvY2tldFN0YWdlO1xuICByZWFkb25seSBhcGlHYXRld2F5Um9sZTogaWFtLlJvbGU7XG4gIHJlYWRvbmx5IGFwaUdhdGV3YXlMb2dHcm91cDogbG9ncy5Mb2dHcm91cDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBCdWlsZFdlYlNvY2tldEFwaVByb3BzIHtcbiAgLyoqXG4gICAqIEV4aXN0aW5nIGluc3RhbmNlIG9mIEFwaUdhdGV3YXkgdjIgV2ViU29ja2V0XG4gICAqL1xuICByZWFkb25seSBleGlzdGluZ1dlYlNvY2tldEFwaT86IGFwaWd3djIuV2ViU29ja2V0QXBpO1xuXG4gIC8qKlxuICAgKiBVc2VyIHByb3ZpZGVkIHByb3BlcnRpZXMgb2YgQXBpZ2F0ZXdheSB2MiBXZWJTb2NrZXRcbiAgICovXG4gIHJlYWRvbmx5IHdlYlNvY2tldEFwaVByb3BzPzogYXBpZ3d2Mi5XZWJTb2NrZXRBcGlQcm9wcztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBCdWlsZFdlYlNvY2tldFF1ZXVlQXBpUmVxdWVzdCB7XG4gIHJlYWRvbmx5IHF1ZXVlOiBzcXMuSVF1ZXVlO1xuICByZWFkb25seSBkZWZhdWx0Um91dGVSZXF1ZXN0VGVtcGxhdGU/OiB7IFtjb250ZW50VHlwZTogc3RyaW5nXTogc3RyaW5nIH07XG4gIHJlYWRvbmx5IGNyZWF0ZURlZmF1bHRSb3V0ZT86IGJvb2xlYW47XG4gIHJlYWRvbmx5IHdlYlNvY2tldEFwaVByb3BzPzogYXBpZ3d2Mi5XZWJTb2NrZXRBcGlQcm9wcztcbiAgcmVhZG9ubHkgZXhpc3RpbmdXZWJTb2NrZXRBcGk/OiBhcGlnd3YyLldlYlNvY2tldEFwaTtcbiAgcmVhZG9ubHkgbG9nR3JvdXBQcm9wcz86IGxvZ3MuTG9nR3JvdXBQcm9wcztcbiAgcmVhZG9ubHkgZGVmYXVsdElhbUF1dGhvcml6YXRpb24/OiBib29sZWFuO1xuICByZWFkb25seSBjdXN0b21Sb3V0ZU5hbWU/OiBzdHJpbmc7XG59XG4vKipcbiAqIEJ1aWxkcyBhbiBBV1MgQVBJIEdhdGV3YXkgV2ViU29ja2V0IEFQSSBpbnRlZ3JhdGVkIHdpdGggYW4gQW1hem9uIFNRUyBxdWV1ZS5cbiAqXG4gKiBAcGFyYW0gc2NvcGUgVGhlIGNvbnN0cnVjdCBzY29wZSB3aGVyZSB0aGUgcmVzb3VyY2VzIHdpbGwgYmUgY3JlYXRlZC5cbiAqIEBwYXJhbSBpZCBUaGUgdW5pcXVlIElEIGZvciB0aGUgcmVzb3VyY2VzLlxuICogQHBhcmFtIHByb3BzIFRoZSBjb25maWd1cmF0aW9uIHByb3BlcnRpZXMgZm9yIHRoZSBXZWJTb2NrZXQgQVBJIGFuZCBTUVMgcXVldWUgaW50ZWdyYXRpb24uXG4gKiBAcmV0dXJuc1xuICovXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRXZWJTb2NrZXRRdWV1ZUFwaShcbiAgc2NvcGU6IENvbnN0cnVjdCxcbiAgaWQ6IHN0cmluZyxcbiAgcHJvcHM6IEJ1aWxkV2ViU29ja2V0UXVldWVBcGlSZXF1ZXN0XG4pOiBCdWlsZFdlYlNvY2tldFF1ZXVlQXBpUmVzcG9uc2Uge1xuICAvLyBTZXR1cCB0aGUgQVBJIEdhdGV3YXkgcm9sZVxuICBjb25zdCBhcGlHYXRld2F5Um9sZSA9IG5ldyBpYW0uUm9sZShzY29wZSwgXCJMYW1iZGFSZXN0QXBpQ2xvdWRXYXRjaFJvbGVcIiwge1xuICAgIGFzc3VtZWRCeTogbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKFwiYXBpZ2F0ZXdheS5hbWF6b25hd3MuY29tXCIpLFxuICB9KTtcbiAgcHJvcHMucXVldWUuZ3JhbnRTZW5kTWVzc2FnZXMoYXBpR2F0ZXdheVJvbGUpO1xuICBjb25zdCBmaW5hbFByb3BzID0gY29uc29saWRhdGVQcm9wcyhcbiAgICBidWlsZFdlYlNvY2tldEFwaVByb3BzKFxuICAgICAgYXBpR2F0ZXdheVJvbGUsXG4gICAgICBwcm9wcy5xdWV1ZSxcbiAgICAgIHByb3BzLmNyZWF0ZURlZmF1bHRSb3V0ZSxcbiAgICAgIHByb3BzLmRlZmF1bHRSb3V0ZVJlcXVlc3RUZW1wbGF0ZSxcbiAgICAgIHByb3BzLmRlZmF1bHRJYW1BdXRob3JpemF0aW9uXG4gICAgKSxcbiAgICBwcm9wcy53ZWJTb2NrZXRBcGlQcm9wc1xuICApIGFzIGFwaWd3djIuV2ViU29ja2V0QXBpUHJvcHM7XG4gIGNvbnN0IHdlYlNvY2tldEFwaSA9IGJ1aWxkQXBpR2F0ZXdheVYyV2ViU29ja2V0KHNjb3BlLCBpZCwge1xuICAgIHdlYlNvY2tldEFwaVByb3BzOiBmaW5hbFByb3BzLFxuICAgIGV4aXN0aW5nV2ViU29ja2V0QXBpOiBwcm9wcy5leGlzdGluZ1dlYlNvY2tldEFwaSxcbiAgfSk7XG5cbiAgaWYgKHByb3BzLmN1c3RvbVJvdXRlTmFtZSkge1xuICAgIHdlYlNvY2tldEFwaS5hZGRSb3V0ZShcbiAgICAgIHByb3BzLmN1c3RvbVJvdXRlTmFtZSxcbiAgICAgIGJ1aWxkV2ViU29ja2V0UXVldWVSb3V0ZU9wdGlvbnMoYXBpR2F0ZXdheVJvbGUsIHByb3BzLnF1ZXVlLCBwcm9wcy5jdXN0b21Sb3V0ZU5hbWUsIHByb3BzLmRlZmF1bHRSb3V0ZVJlcXVlc3RUZW1wbGF0ZSlcbiAgICApO1xuICB9XG5cbiAgaWYgKFxuICAgIHByb3BzLmV4aXN0aW5nV2ViU29ja2V0QXBpID09PSB1bmRlZmluZWQgJiZcbiAgICBwcm9wcy5kZWZhdWx0SWFtQXV0aG9yaXphdGlvbiA9PT0gZmFsc2UgJiZcbiAgICBmaW5hbFByb3BzLmNvbm5lY3RSb3V0ZU9wdGlvbnM/LmF1dGhvcml6ZXIgPT09IHVuZGVmaW5lZFxuICApIHtcbiAgICBwcmludFdhcm5pbmcoXG4gICAgICBcIlRoaXMgY29uc3RydWN0IHdpbGwgY3JlYXRlIGEgV2ViU29ja2V0IHdpdGggTk8gQXV0aG9yaXplciAoZGVmYXVsdElhbUF1dGhvcml6YXRpb24gaXMgc2V0IHRvIGZhbHNlKS5cIlxuICAgICk7XG4gIH1cblxuICBjb25zdCB3ZWJTb2NrZXRTdGFnZSA9IG5ldyBhcGlnd3YyLldlYlNvY2tldFN0YWdlKHNjb3BlLCBcIlN0YWdlXCIsIHtcbiAgICBzdGFnZU5hbWU6IFwicHJvZFwiLFxuICAgIHdlYlNvY2tldEFwaSxcbiAgICBhdXRvRGVwbG95OiB0cnVlLFxuICB9KTtcblxuICBhZGRDZm5HdWFyZFN1cHByZXNzUnVsZXMod2ViU29ja2V0U3RhZ2UsIFtcIkFQSV9HV19DQUNIRV9FTkFCTEVEX0FORF9FTkNSWVBURURcIl0pO1xuXG4gIGNvbnN0IGFwaUdhdGV3YXlMb2dHcm91cCA9IGJ1aWxkTG9nR3JvdXAoc2NvcGUsIFwiTG9nR3JvdXBcIiwgcHJvcHMubG9nR3JvdXBQcm9wcyk7XG4gIGFwaUdhdGV3YXlMb2dHcm91cC5ncmFudChcbiAgICBhcGlHYXRld2F5Um9sZSxcbiAgICBcImxvZ3M6Q3JlYXRlTG9nR3JvdXBcIixcbiAgICBcImxvZ3M6Q3JlYXRlTG9nU3RyZWFtXCIsXG4gICAgXCJsb2dzOkRlc2NyaWJlTG9nR3JvdXBzXCIsXG4gICAgXCJsb2dzOkRlc2NyaWJlTG9nU3RyZWFtc1wiLFxuICAgIFwibG9nczpQdXRMb2dFdmVudHNcIixcbiAgICBcImxvZ3M6R2V0TG9nRXZlbnRzXCIsXG4gICAgXCJsb2dzOkZpbHRlckxvZ0V2ZW50c1wiXG4gICk7XG5cbiAgY29uc3QgY2ZuU3RhZ2U6IGFwaWd3djIuQ2ZuU3RhZ2UgPSB3ZWJTb2NrZXRTdGFnZS5ub2RlLmRlZmF1bHRDaGlsZCBhcyBhcGlnd3YyLkNmblN0YWdlO1xuICBjZm5TdGFnZS5hZGRQcm9wZXJ0eU92ZXJyaWRlKFwiQWNjZXNzTG9nU2V0dGluZ3NcIiwge1xuICAgIERlc3RpbmF0aW9uQXJuOiBhcGlHYXRld2F5TG9nR3JvdXAubG9nR3JvdXBBcm4sXG4gICAgRm9ybWF0OiBhcGlnYXRld2F5LkFjY2Vzc0xvZ0Zvcm1hdC5jbGYoKS50b1N0cmluZygpLFxuICB9KTtcbiAgY2ZuU3RhZ2UuYWRkUHJvcGVydHlPdmVycmlkZShcIkRlZmF1bHRSb3V0ZVNldHRpbmdzXCIsIHtcbiAgICBEYXRhVHJhY2VFbmFibGVkOiBmYWxzZSxcbiAgICBEZXRhaWxlZE1ldHJpY3NFbmFibGVkOiB0cnVlLFxuICAgIExvZ2dpbmdMZXZlbDogXCJFUlJPUlwiLFxuICB9KTtcblxuICBhZGRDZm5TdXBwcmVzc1J1bGVzKHdlYlNvY2tldFN0YWdlLCBbXG4gICAge1xuICAgICAgaWQ6IFwiQXdzU29sdXRpb25zLUFQSUcxXCIsXG4gICAgICByZWFzb246IFwiQWNjZXNzIGxvZ2dpbmcgY29uZmlndXJhdGlvbiBoYXMgYmVlbiBwcm92aWRlZCBhcyBwZXIgQXBpR2F0ZXdheSB2MiByZXF1aXJlbWVudHNcIixcbiAgICB9LFxuICBdKTtcblxuICBhZGRDZm5TdXBwcmVzc1J1bGVzKFxuICAgIGFwaUdhdGV3YXlSb2xlLm5vZGUudHJ5RmluZENoaWxkKFwiRGVmYXVsdFBvbGljeVwiKT8ubm9kZS50cnlGaW5kQ2hpbGQoXCJSZXNvdXJjZVwiKSBhcyBjZGsuQ2ZuUmVzb3VyY2UsXG4gICAgW1xuICAgICAge1xuICAgICAgICBpZDogXCJBd3NTb2x1dGlvbnMtSUFNNVwiLFxuICAgICAgICByZWFzb246IFwiVGhlIEFQSUdhdGV3YXkgcmVxdWlyZXMgcGVybWlzc2lvbnMgdG8gS01TIHNvIHRoYXQgaXQgY2FuIHdyaXRlIHRvIGFuIGVuY3J5cHRlZCBTUVMgcXVldWVcIixcbiAgICAgIH0sXG4gICAgXVxuICApO1xuXG4gIHJldHVybiB7XG4gICAgd2ViU29ja2V0QXBpLFxuICAgIHdlYlNvY2tldFN0YWdlLFxuICAgIGFwaUdhdGV3YXlSb2xlLFxuICAgIGFwaUdhdGV3YXlMb2dHcm91cCxcbiAgfTtcbn1cblxuLyoqXG4gKiBidWlsZCBBcGlHYXRld2F5IHYyIFdlYlNvY2tldCBMMiBjb25zdHJ1Y3QuIElmIGV4aXN0aW5nIFdlYlNvY2tldEFwaSBpbnN0YW5jZSBpcyBwcm92aWRlZCwgaXQgcmV0dXJucyB0aGF0IGluc3RhbmNlLFxuICogaWYgbm90LCBpdCBjcmVhdGVzIGEgbmV3IFdlYlNvY2tldEFwaSB1c2luZyB0aGUgdXNlciBwcm92aWRlZCBwcm9wcy5cbiAqXG4gKiBAcGFyYW0gc2NvcGVcbiAqIEBwYXJhbSBwcm9wc1xuICogQHJldHVybnNcbiAqL1xuZnVuY3Rpb24gYnVpbGRBcGlHYXRld2F5VjJXZWJTb2NrZXQoc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEJ1aWxkV2ViU29ja2V0QXBpUHJvcHMpOiBhcGlnd3YyLldlYlNvY2tldEFwaSB7XG4gIGlmIChwcm9wcy5leGlzdGluZ1dlYlNvY2tldEFwaSkge1xuICAgIHJldHVybiBwcm9wcy5leGlzdGluZ1dlYlNvY2tldEFwaTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gbmV3IGFwaWd3djIuV2ViU29ja2V0QXBpKHNjb3BlLCBgV2ViU29ja2V0QXBpJHtpZH1gLCBwcm9wcy53ZWJTb2NrZXRBcGlQcm9wcyk7XG4gIH1cbn1cblxuLyoqXG4gKiBAaW50ZXJuYWwgVGhpcyBpcyBhbiBpbnRlcm5hbCBjb3JlIGZ1bmN0aW9uIGFuZCBzaG91bGQgbm90IGJlIGNhbGxlZCBkaXJlY3RseSBieSBTb2x1dGlvbnMgQ29uc3RydWN0cyBjbGllbnRzLlxuICovXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRXZWJTb2NrZXRBcGlQcm9wcyhcbiAgcm9sZT86IGlhbS5Sb2xlLFxuICBzcXNRdWV1ZT86IHNxcy5JUXVldWUsXG4gIGNyZWF0ZURlZmF1bHRSb3V0ZT86IGJvb2xlYW4sXG4gIHJlcXVlc3RUZW1wbGF0ZT86IHsgW2NvbnRlbnRUeXBlOiBzdHJpbmddOiBzdHJpbmcgfSxcbiAgZGVmYXVsdElhbUF1dGhvcml6YXRpb24/OiBib29sZWFuXG4pOiBhcGlnd3YyLldlYlNvY2tldEFwaVByb3BzIHtcbiAgaWYgKGNyZWF0ZURlZmF1bHRSb3V0ZSkge1xuICAgIGlmICghcm9sZSB8fCAhc3FzUXVldWUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcInJvbGUgYW5kIHNxcyBtdXN0IGJlIHByb3ZpZGVkIHRvIGNyZWF0ZSBhIGRlZmF1bHQgcm91dGVcIik7XG4gICAgfVxuICB9XG5cbiAgLy8gcHJldHRpZXItaWdub3JlXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gIC8vIFNvbmFyIGV4Y2VwdGlvbiByZWFzb246IC0gdHlwZXNjcmlwdDpTNjU3MSAtIHJlcXVpcmVkIGJlY2F1c2Ugd2UgYXJlIG5vdCBwYXNzaW5nIGFsbCB2YWx1ZXMuIFVzaW5nIHBhcnRpYWwgbWF5IGNhdXNlIEBqc2lpIHRvIG5vdCB3b3JrLlxuICBjb25zdCB3ZWJzb2NrZXRBcGlQcm9wczogYXBpZ3d2Mi5XZWJTb2NrZXRBcGlQcm9wcyA9IHsgLy8gTk9TT05BUlxuICAgIGRlZmF1bHRSb3V0ZU9wdGlvbnM6IGNyZWF0ZURlZmF1bHRSb3V0ZSA/IGJ1aWxkV2ViU29ja2V0UXVldWVSb3V0ZU9wdGlvbnMocm9sZSEsIHNxc1F1ZXVlISwgJyRkZWZhdWx0JywgcmVxdWVzdFRlbXBsYXRlKSA6IHVuZGVmaW5lZCxcbiAgICBjb25uZWN0Um91dGVPcHRpb25zOiAoZGVmYXVsdElhbUF1dGhvcml6YXRpb24gPT09IHVuZGVmaW5lZCB8fCBkZWZhdWx0SWFtQXV0aG9yaXphdGlvbiA9PT0gdHJ1ZSkgPyBjb25uZWN0Um91dGVPcHRpb25zIDogdW5kZWZpbmVkXG4gIH07XG4gIHJldHVybiB3ZWJzb2NrZXRBcGlQcm9wcztcbn1cblxuLyoqXG4gKiBAaW50ZXJuYWwgVGhpcyBpcyBhbiBpbnRlcm5hbCBjb3JlIGZ1bmN0aW9uIGFuZCBzaG91bGQgbm90IGJlIGNhbGxlZCBkaXJlY3RseSBieSBTb2x1dGlvbnMgQ29uc3RydWN0cyBjbGllbnRzLlxuICovXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRXZWJTb2NrZXRRdWV1ZVJvdXRlT3B0aW9ucyhcbiAgcm9sZTogaWFtLlJvbGUsXG4gIHNxc1F1ZXVlOiBzcXMuSVF1ZXVlLFxuICByb3V0ZU5hbWU6IHN0cmluZyxcbiAgcmVxdWVzdFRlbXBsYXRlPzogeyBbY29udGVudFR5cGU6IHN0cmluZ106IHN0cmluZyB9XG4pOiBhcGlnd3YyLldlYlNvY2tldFJvdXRlT3B0aW9ucyB7XG4gIHJldHVybiB7XG4gICAgaW50ZWdyYXRpb246IG5ldyBXZWJTb2NrZXRBd3NJbnRlZ3JhdGlvbihyb3V0ZU5hbWUsIHtcbiAgICAgIGludGVncmF0aW9uTWV0aG9kOiBhcGlnd3YyLkh0dHBNZXRob2QuUE9TVCxcbiAgICAgIGludGVncmF0aW9uVXJpOiBgYXJuOiR7Y2RrLkF3cy5QQVJUSVRJT059OmFwaWdhdGV3YXk6JHtjZGsuQXdzLlJFR0lPTn06c3FzOnBhdGgvJHtjZGsuQXdzLkFDQ09VTlRfSUR9LyR7c3FzUXVldWUucXVldWVOYW1lfWAsXG4gICAgICByZXF1ZXN0VGVtcGxhdGVzOiByZXF1ZXN0VGVtcGxhdGUgPz8ge1xuICAgICAgICBbcm91dGVOYW1lID09PSBcIiRkZWZhdWx0XCIgPyBcIiRkZWZhdWx0XCIgOiByb3V0ZU5hbWVdOiBERUZBVUxUX1JPVVRFX1FVRVVFX1ZUTF9DT05GSUcsXG4gICAgICB9LFxuICAgICAgdGVtcGxhdGVTZWxlY3Rpb25FeHByZXNzaW9uOiByb3V0ZU5hbWUgPT09IFwiJGRlZmF1bHRcIiA/IFwiXFxcXCRkZWZhdWx0XCIgOiByb3V0ZU5hbWUsXG4gICAgICBwYXNzdGhyb3VnaEJlaGF2aW9yOiBhcGlnd3YyLlBhc3N0aHJvdWdoQmVoYXZpb3IuTkVWRVIsXG4gICAgICBjcmVkZW50aWFsc1JvbGU6IHJvbGUsXG4gICAgICByZXF1ZXN0UGFyYW1ldGVyczoge1xuICAgICAgICBcImludGVncmF0aW9uLnJlcXVlc3QuaGVhZGVyLkNvbnRlbnQtVHlwZVwiOiBcIidhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnXCIsXG4gICAgICB9LFxuICAgIH0pLFxuICB9O1xufVxuIl19