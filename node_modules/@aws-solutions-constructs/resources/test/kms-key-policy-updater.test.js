"use strict";
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const aws_sdk_client_mock_1 = require("aws-sdk-client-mock");
const client_kms_1 = require("@aws-sdk/client-kms");
const key_policy_updater_custom_resource_1 = require("../lib/key-policy-updater-custom-resource");
const kmsMock = (0, aws_sdk_client_mock_1.mockClient)(client_kms_1.KMSClient);
beforeEach(() => {
    kmsMock.reset();
});
it('Should exit if an AWS managed key is provided; return a success code but give the exact reason', async () => {
    // Mocks
    kmsMock.on(client_kms_1.DescribeKeyCommand).resolves({
        KeyMetadata: {
            KeyId: 'sample-key-id',
            KeyManager: client_kms_1.KeyManagerType.AWS
        }
    });
    // Arrange
    const e = {
        RequestType: 'Create',
        ResourceProperties: {
            CloudFrontDistributionId: 'sample-cf-distro-id',
            AccountId: '111122223333'
        }
    };
    const context = {
    // ...
    };
    // Act
    const res = await (0, key_policy_updater_custom_resource_1.handler)(e, context);
    // Assert
    expect(res.Status).toBe('SUCCESS');
    expect(res.Data).toBe('An AWS managed key was provided, no action needed from the custom resource, exiting now.');
});
it('Should return an error if the key policy is returned as undefined', async () => {
    // Mocks
    kmsMock.on(client_kms_1.DescribeKeyCommand).resolves({
        KeyMetadata: {
            KeyId: 'sample-key-id',
            KeyManager: client_kms_1.KeyManagerType.CUSTOMER
        }
    });
    kmsMock.on(client_kms_1.GetKeyPolicyCommand).resolves({
        Policy: undefined
    });
    // Arrange
    const e = {
        RequestType: 'Update',
        ResourceProperties: {
            CloudFrontDistributionId: 'sample-cf-distro-id',
            AccountId: '111122223333'
        }
    };
    const context = {
    // ...
    };
    // Act
    const res = await (0, key_policy_updater_custom_resource_1.handler)(e, context);
    // Assert
    expect(res.Status).toBe('FAILED');
});
it('Should update the key policy if the proper params are given', async () => {
    // Mocks
    kmsMock.on(client_kms_1.DescribeKeyCommand).resolves({
        KeyMetadata: {
            KeyId: 'sample-key-id',
            KeyManager: client_kms_1.KeyManagerType.CUSTOMER
        }
    });
    kmsMock.on(client_kms_1.GetKeyPolicyCommand).resolves({
        Policy: `{\n
      \"Version\" : \"2012-10-17\",\n
      \"Id\" : \"sample-key-id\",\n
      \"Statement\" : [ {\n
          \"Sid\" : \"Grant-CloudFront-Distribution-Key-Usage\",\n
          \"Effect\" : \"Allow\",\n
          \"Principal\" : {\n
              \"AWS\" : \"arn:aws:iam::111122223333:root\"\n
          },\n
          \"Action\" : \"kms:*\",\n
          \"Resource\" : \"*\"\n
      } ]\n
    }`
    });
    // Arrange
    const e = {
        RequestType: 'Update',
        ResourceProperties: {
            CloudFrontDistributionId: 'sample-cf-distro-id',
            AccountId: '111122223333'
        }
    };
    const context = {
    // ...
    };
    // Act
    const res = await (0, key_policy_updater_custom_resource_1.handler)(e, context);
    // Assert
    expect(res.Status).toBe('SUCCESS');
});
it('Should fail if an error occurs with putting the new key policy, all other inputs valid', async () => {
    // Mocks
    kmsMock.on(client_kms_1.DescribeKeyCommand).resolves({
        KeyMetadata: {
            KeyId: 'sample-key-id',
            KeyManager: client_kms_1.KeyManagerType.CUSTOMER
        }
    });
    kmsMock.on(client_kms_1.GetKeyPolicyCommand).resolves({
        Policy: `{\n
      \"Version\" : \"2012-10-17\",\n
      \"Id\" : \"key-default-1\",\n
      \"Statement\" : [ {\n
          \"Sid\" : \"Grant-CloudFront-Distribution-Key-Usage\",\n
          \"Effect\" : \"Allow\",\n
          \"Principal\" : {\n
              \"AWS\" : \"arn:aws:iam::111122223333:root\"\n
          },\n
          \"Action\" : \"kms:*\",\n
          \"Resource\" : \"*\"\n
      } ]\n
    }`
    });
    kmsMock.on(client_kms_1.PutKeyPolicyCommand).rejects();
    const e = {
        RequestType: 'Update',
        ResourceProperties: {
            CloudFrontDistributionId: 'sample-cf-distro-id',
            AccountId: '111122223333'
        }
    };
    const context = {
    // ...
    };
    // Act
    const res = await (0, key_policy_updater_custom_resource_1.handler)(e, context);
    // Assert
    expect(res.Status).toBe('FAILED');
});
it('Should fail if the key policy has already been applied in a previous stack update or similar event (custom resource response)', async () => {
    // Mocks
    kmsMock.on(client_kms_1.DescribeKeyCommand).resolves({
        KeyMetadata: {
            KeyId: 'sample-key-id',
            KeyManager: client_kms_1.KeyManagerType.CUSTOMER
        }
    });
    kmsMock.on(client_kms_1.GetKeyPolicyCommand).resolves({
        Policy: `{\n
      \"Version\" : \"2012-10-17\",\n
      \"Id\" : \"key-default-1\",\n
      \"Statement\" : [ {\n
          \"Sid\" : \"Grant-CloudFront-Distribution-Key-Usage\",\n
          \"Effect\" : \"Allow\",\n
          \"Principal\" : {\n
              \"AWS\" : \"arn:aws:iam::111122223333:root\"\n
          },\n
          \"Action\" : \"kms:*\",\n
          \"Resource\" : \"*\"\n
      } ]\n
    }`
    });
    const e = {
        RequestType: 'Update',
        ResourceProperties: {
            CloudFrontDistributionId: 'sample-cf-distro-id',
            AccountId: '111122223333'
        }
    };
    const context = {
    // ...
    };
    // Act
    const res = await (0, key_policy_updater_custom_resource_1.handler)(e, context);
    // Assert
    expect(res.Status).toBe('SUCCESS');
});
it('updateKeyPolicy() should overwrite an existing key policy statement that matches on the sid', async () => {
    // Arrange
    const keyPolicy = {
        Version: "2012-10-17",
        Id: "key-default-1",
        Statement: [
            {
                Sid: 'Grant-CloudFront-Distribution-Key-Usage',
                Effect: "Allow"
            },
            {
                Sid: 'Some-Other-Key-Policy-Statement',
                Effect: "Allow"
            }
        ]
    };
    const keyPolicyStatement = {
        Sid: 'Grant-CloudFront-Distribution-Key-Usage',
        Effect: "Deny"
    };
    // Act
    const res = (0, key_policy_updater_custom_resource_1.updateKeyPolicy)(keyPolicy, keyPolicyStatement);
    // Assert
    expect(res.Statement[0].Sid).toBe('Grant-CloudFront-Distribution-Key-Usage');
    expect(res.Statement[0].Effect).toBe('Deny');
});
it('updateKeyPolicy() should add the key policy statement if one with matching sid does not already exist', async () => {
    // Arrange
    const keyPolicy = {
        Version: "2012-10-17",
        Id: "key-default-1",
        Statement: [
            {
                Sid: 'Some-Other-Key-Policy-Statement',
                Effect: "Allow"
            }
        ]
    };
    const keyPolicyStatement = {
        Sid: 'Grant-CloudFront-Distribution-Key-Usage',
        Effect: "Deny"
    };
    // Act
    const res = (0, key_policy_updater_custom_resource_1.updateKeyPolicy)(keyPolicy, keyPolicyStatement);
    // Assert
    expect(res.Statement[1].Sid).toBe('Grant-CloudFront-Distribution-Key-Usage');
    expect(res.Statement[1].Effect).toBe('Deny');
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia21zLWtleS1wb2xpY3ktdXBkYXRlci50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsia21zLWtleS1wb2xpY3ktdXBkYXRlci50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7R0FXRzs7QUFFSCw2REFBaUQ7QUFDakQsb0RBQThIO0FBQzlILGtHQUFxRjtBQUVyRixNQUFNLE9BQU8sR0FBRyxJQUFBLGdDQUFVLEVBQUMsc0JBQVMsQ0FBQyxDQUFDO0FBRXRDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDZCxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDbEIsQ0FBQyxDQUFDLENBQUM7QUFFSCxFQUFFLENBQUMsZ0dBQWdHLEVBQUUsS0FBSyxJQUFJLEVBQUU7SUFDOUcsUUFBUTtJQUNSLE9BQU8sQ0FBQyxFQUFFLENBQUMsK0JBQWtCLENBQUMsQ0FBQyxRQUFRLENBQUM7UUFDdEMsV0FBVyxFQUFFO1lBQ1gsS0FBSyxFQUFFLGVBQWU7WUFDdEIsVUFBVSxFQUFFLDJCQUFjLENBQUMsR0FBRztTQUMvQjtLQUNGLENBQUMsQ0FBQztJQUNILFVBQVU7SUFDVixNQUFNLENBQUMsR0FBRztRQUNSLFdBQVcsRUFBRSxRQUFRO1FBQ3JCLGtCQUFrQixFQUFFO1lBQ2xCLHdCQUF3QixFQUFFLHFCQUFxQjtZQUMvQyxTQUFTLEVBQUUsY0FBYztTQUMxQjtLQUNGLENBQUM7SUFDRixNQUFNLE9BQU8sR0FBRztJQUNkLE1BQU07S0FDUCxDQUFDO0lBQ0YsTUFBTTtJQUNOLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBQSw0Q0FBTyxFQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUN0QyxTQUFTO0lBQ1QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDbkMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsMEZBQTBG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QUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMseUNBQXlDLENBQUMsQ0FBQztJQUM3RSxNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDL0MsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqICBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiAgTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS4gWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuICogIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0XG4gKlxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiAgb3IgaW4gdGhlICdsaWNlbnNlJyBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAnQVMgSVMnIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVNcbiAqICBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9uc1xuICogIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBtb2NrQ2xpZW50IH0gZnJvbSBcImF3cy1zZGstY2xpZW50LW1vY2tcIjtcbmltcG9ydCB7IEtNU0NsaWVudCwgRGVzY3JpYmVLZXlDb21tYW5kLCBLZXlNYW5hZ2VyVHlwZSwgR2V0S2V5UG9saWN5Q29tbWFuZCwgUHV0S2V5UG9saWN5Q29tbWFuZCB9IGZyb20gXCJAYXdzLXNkay9jbGllbnQta21zXCI7XG5pbXBvcnQgeyBoYW5kbGVyLCB1cGRhdGVLZXlQb2xpY3kgfSBmcm9tIFwiLi4vbGliL2tleS1wb2xpY3ktdXBkYXRlci1jdXN0b20tcmVzb3VyY2VcIjtcblxuY29uc3Qga21zTW9jayA9IG1vY2tDbGllbnQoS01TQ2xpZW50KTtcblxuYmVmb3JlRWFjaCgoKSA9PiB7XG4gIGttc01vY2sucmVzZXQoKTtcbn0pO1xuXG5pdCgnU2hvdWxkIGV4aXQgaWYgYW4gQVdTIG1hbmFnZWQga2V5IGlzIHByb3ZpZGVkOyByZXR1cm4gYSBzdWNjZXNzIGNvZGUgYnV0IGdpdmUgdGhlIGV4YWN0IHJlYXNvbicsIGFzeW5jICgpID0+IHtcbiAgLy8gTW9ja3NcbiAga21zTW9jay5vbihEZXNjcmliZUtleUNvbW1hbmQpLnJlc29sdmVzKHtcbiAgICBLZXlNZXRhZGF0YToge1xuICAgICAgS2V5SWQ6ICdzYW1wbGUta2V5LWlkJyxcbiAgICAgIEtleU1hbmFnZXI6IEtleU1hbmFnZXJUeXBlLkFXU1xuICAgIH1cbiAgfSk7XG4gIC8vIEFycmFuZ2VcbiAgY29uc3QgZSA9IHtcbiAgICBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScsXG4gICAgUmVzb3VyY2VQcm9wZXJ0aWVzOiB7XG4gICAgICBDbG91ZEZyb250RGlzdHJpYnV0aW9uSWQ6ICdzYW1wbGUtY2YtZGlzdHJvLWlkJyxcbiAgICAgIEFjY291bnRJZDogJzExMTEyMjIyMzMzMydcbiAgICB9XG4gIH07XG4gIGNvbnN0IGNvbnRleHQgPSB7XG4gICAgLy8gLi4uXG4gIH07XG4gIC8vIEFjdFxuICBjb25zdCByZXMgPSBhd2FpdCBoYW5kbGVyKGUsIGNvbnRleHQpO1xuICAvLyBBc3NlcnRcbiAgZXhwZWN0KHJlcy5TdGF0dXMpLnRvQmUoJ1NVQ0NFU1MnKTtcbiAgZXhwZWN0KHJlcy5EYXRhKS50b0JlKCdBbiBBV1MgbWFuYWdlZCBrZXkgd2FzIHByb3ZpZGVkLCBubyBhY3Rpb24gbmVlZGVkIGZyb20gdGhlIGN1c3RvbSByZXNvdXJjZSwgZXhpdGluZyBub3cuJyk7XG59KTtcblxuaXQoJ1Nob3VsZCByZXR1cm4gYW4gZXJyb3IgaWYgdGhlIGtleSBwb2xpY3kgaXMgcmV0dXJuZWQgYXMgdW5kZWZpbmVkJywgYXN5bmMgKCkgPT4ge1xuICAvLyBNb2Nrc1xuICBrbXNNb2NrLm9uKERlc2NyaWJlS2V5Q29tbWFuZCkucmVzb2x2ZXMoe1xuICAgIEtleU1ldGFkYXRhOiB7XG4gICAgICBLZXlJZDogJ3NhbXBsZS1rZXktaWQnLFxuICAgICAgS2V5TWFuYWdlcjogS2V5TWFuYWdlclR5cGUuQ1VTVE9NRVJcbiAgICB9XG4gIH0pO1xuICBrbXNNb2NrLm9uKEdldEtleVBvbGljeUNvbW1hbmQpLnJlc29sdmVzKHtcbiAgICBQb2xpY3k6IHVuZGVmaW5lZFxuICB9KTtcbiAgLy8gQXJyYW5nZVxuICBjb25zdCBlID0ge1xuICAgIFJlcXVlc3RUeXBlOiAnVXBkYXRlJyxcbiAgICBSZXNvdXJjZVByb3BlcnRpZXM6IHtcbiAgICAgIENsb3VkRnJvbnREaXN0cmlidXRpb25JZDogJ3NhbXBsZS1jZi1kaXN0cm8taWQnLFxuICAgICAgQWNjb3VudElkOiAnMTExMTIyMjIzMzMzJ1xuICAgIH1cbiAgfTtcbiAgY29uc3QgY29udGV4dCA9IHtcbiAgICAvLyAuLi5cbiAgfTtcbiAgLy8gQWN0XG4gIGNvbnN0IHJlcyA9IGF3YWl0IGhhbmRsZXIoZSwgY29udGV4dCk7XG4gIC8vIEFzc2VydFxuICBleHBlY3QocmVzLlN0YXR1cykudG9CZSgnRkFJTEVEJyk7XG59KTtcblxuaXQoJ1Nob3VsZCB1cGRhdGUgdGhlIGtleSBwb2xpY3kgaWYgdGhlIHByb3BlciBwYXJhbXMgYXJlIGdpdmVuJywgYXN5bmMgKCkgPT4ge1xuICAvLyBNb2Nrc1xuICBrbXNNb2NrLm9uKERlc2NyaWJlS2V5Q29tbWFuZCkucmVzb2x2ZXMoe1xuICAgIEtleU1ldGFkYXRhOiB7XG4gICAgICBLZXlJZDogJ3NhbXBsZS1rZXktaWQnLFxuICAgICAgS2V5TWFuYWdlcjogS2V5TWFuYWdlclR5cGUuQ1VTVE9NRVJcbiAgICB9XG4gIH0pO1xuICBrbXNNb2NrLm9uKEdldEtleVBvbGljeUNvbW1hbmQpLnJlc29sdmVzKHtcbiAgICBQb2xpY3k6IGB7XFxuXG4gICAgICBcXFwiVmVyc2lvblxcXCIgOiBcXFwiMjAxMi0xMC0xN1xcXCIsXFxuXG4gICAgICBcXFwiSWRcXFwiIDogXFxcInNhbXBsZS1rZXktaWRcXFwiLFxcblxuICAgICAgXFxcIlN0YXRlbWVudFxcXCIgOiBbIHtcXG5cbiAgICAgICAgICBcXFwiU2lkXFxcIiA6IFxcXCJHcmFudC1DbG91ZEZyb250LURpc3RyaWJ1dGlvbi1LZXktVXNhZ2VcXFwiLFxcblxuICAgICAgICAgIFxcXCJFZmZlY3RcXFwiIDogXFxcIkFsbG93XFxcIixcXG5cbiAgICAgICAgICBcXFwiUHJpbmNpcGFsXFxcIiA6IHtcXG5cbiAgICAgICAgICAgICAgXFxcIkFXU1xcXCIgOiBcXFwiYXJuOmF3czppYW06OjExMTEyMjIyMzMzMzpyb290XFxcIlxcblxuICAgICAgICAgIH0sXFxuXG4gICAgICAgICAgXFxcIkFjdGlvblxcXCIgOiBcXFwia21zOipcXFwiLFxcblxuICAgICAgICAgIFxcXCJSZXNvdXJjZVxcXCIgOiBcXFwiKlxcXCJcXG5cbiAgICAgIH0gXVxcblxuICAgIH1gXG4gIH0pO1xuICAvLyBBcnJhbmdlXG4gIGNvbnN0IGUgPSB7XG4gICAgUmVxdWVzdFR5cGU6ICdVcGRhdGUnLFxuICAgIFJlc291cmNlUHJvcGVydGllczoge1xuICAgICAgQ2xvdWRGcm9udERpc3RyaWJ1dGlvbklkOiAnc2FtcGxlLWNmLWRpc3Ryby1pZCcsXG4gICAgICBBY2NvdW50SWQ6ICcxMTExMjIyMjMzMzMnXG4gICAgfVxuICB9O1xuICBjb25zdCBjb250ZXh0ID0ge1xuICAgIC8vIC4uLlxuICB9O1xuICAvLyBBY3RcbiAgY29uc3QgcmVzID0gYXdhaXQgaGFuZGxlcihlLCBjb250ZXh0KTtcbiAgLy8gQXNzZXJ0XG4gIGV4cGVjdChyZXMuU3RhdHVzKS50b0JlKCdTVUNDRVNTJyk7XG59KTtcblxuaXQoJ1Nob3VsZCBmYWlsIGlmIGFuIGVycm9yIG9jY3VycyB3aXRoIHB1dHRpbmcgdGhlIG5ldyBrZXkgcG9saWN5LCBhbGwgb3RoZXIgaW5wdXRzIHZhbGlkJywgYXN5bmMgKCkgPT4ge1xuICAvLyBNb2Nrc1xuICBrbXNNb2NrLm9uKERlc2NyaWJlS2V5Q29tbWFuZCkucmVzb2x2ZXMoe1xuICAgIEtleU1ldGFkYXRhOiB7XG4gICAgICBLZXlJZDogJ3NhbXBsZS1rZXktaWQnLFxuICAgICAgS2V5TWFuYWdlcjogS2V5TWFuYWdlclR5cGUuQ1VTVE9NRVJcbiAgICB9XG4gIH0pO1xuICBrbXNNb2NrLm9uKEdldEtleVBvbGljeUNvbW1hbmQpLnJlc29sdmVzKHtcbiAgICBQb2xpY3k6IGB7XFxuXG4gICAgICBcXFwiVmVyc2lvblxcXCIgOiBcXFwiMjAxMi0xMC0xN1xcXCIsXFxuXG4gICAgICBcXFwiSWRcXFwiIDogXFxcImtleS1kZWZhdWx0LTFcXFwiLFxcblxuICAgICAgXFxcIlN0YXRlbWVudFxcXCIgOiBbIHtcXG5cbiAgICAgICAgICBcXFwiU2lkXFxcIiA6IFxcXCJHcmFudC1DbG91ZEZyb250LURpc3RyaWJ1dGlvbi1LZXktVXNhZ2VcXFwiLFxcblxuICAgICAgICAgIFxcXCJFZmZlY3RcXFwiIDogXFxcIkFsbG93XFxcIixcXG5cbiAgICAgICAgICBcXFwiUHJpbmNpcGFsXFxcIiA6IHtcXG5cbiAgICAgICAgICAgICAgXFxcIkFXU1xcXCIgOiBcXFwiYXJuOmF3czppYW06OjExMTEyMjIyMzMzMzpyb290XFxcIlxcblxuICAgICAgICAgIH0sXFxuXG4gICAgICAgICAgXFxcIkFjdGlvblxcXCIgOiBcXFwia21zOipcXFwiLFxcblxuICAgICAgICAgIFxcXCJSZXNvdXJjZVxcXCIgOiBcXFwiKlxcXCJcXG5cbiAgICAgIH0gXVxcblxuICAgIH1gXG4gIH0pO1xuICBrbXNNb2NrLm9uKFB1dEtleVBvbGljeUNvbW1hbmQpLnJlamVjdHMoKTtcbiAgY29uc3QgZSA9IHtcbiAgICBSZXF1ZXN0VHlwZTogJ1VwZGF0ZScsXG4gICAgUmVzb3VyY2VQcm9wZXJ0aWVzOiB7XG4gICAgICBDbG91ZEZyb250RGlzdHJpYnV0aW9uSWQ6ICdzYW1wbGUtY2YtZGlzdHJvLWlkJyxcbiAgICAgIEFjY291bnRJZDogJzExMTEyMjIyMzMzMydcbiAgICB9XG4gIH07XG4gIGNvbnN0IGNvbnRleHQgPSB7XG4gICAgLy8gLi4uXG4gIH07XG4gIC8vIEFjdFxuICBjb25zdCByZXMgPSBhd2FpdCBoYW5kbGVyKGUsIGNvbnRleHQpO1xuICAvLyBBc3NlcnRcbiAgZXhwZWN0KHJlcy5TdGF0dXMpLnRvQmUoJ0ZBSUxFRCcpO1xufSk7XG5cbml0KCdTaG91bGQgZmFpbCBpZiB0aGUga2V5IHBvbGljeSBoYXMgYWxyZWFkeSBiZWVuIGFwcGxpZWQgaW4gYSBwcmV2aW91cyBzdGFjayB1cGRhdGUgb3Igc2ltaWxhciBldmVudCAoY3VzdG9tIHJlc291cmNlIHJlc3BvbnNlKScsIGFzeW5jICgpID0+IHtcbiAgLy8gTW9ja3NcbiAga21zTW9jay5vbihEZXNjcmliZUtleUNvbW1hbmQpLnJlc29sdmVzKHtcbiAgICBLZXlNZXRhZGF0YToge1xuICAgICAgS2V5SWQ6ICdzYW1wbGUta2V5LWlkJyxcbiAgICAgIEtleU1hbmFnZXI6IEtleU1hbmFnZXJUeXBlLkNVU1RPTUVSXG4gICAgfVxuICB9KTtcbiAga21zTW9jay5vbihHZXRLZXlQb2xpY3lDb21tYW5kKS5yZXNvbHZlcyh7XG4gICAgUG9saWN5OiBge1xcblxuICAgICAgXFxcIlZlcnNpb25cXFwiIDogXFxcIjIwMTItMTAtMTdcXFwiLFxcblxuICAgICAgXFxcIklkXFxcIiA6IFxcXCJrZXktZGVmYXVsdC0xXFxcIixcXG5cbiAgICAgIFxcXCJTdGF0ZW1lbnRcXFwiIDogWyB7XFxuXG4gICAgICAgICAgXFxcIlNpZFxcXCIgOiBcXFwiR3JhbnQtQ2xvdWRGcm9udC1EaXN0cmlidXRpb24tS2V5LVVzYWdlXFxcIixcXG5cbiAgICAgICAgICBcXFwiRWZmZWN0XFxcIiA6IFxcXCJBbGxvd1xcXCIsXFxuXG4gICAgICAgICAgXFxcIlByaW5jaXBhbFxcXCIgOiB7XFxuXG4gICAgICAgICAgICAgIFxcXCJBV1NcXFwiIDogXFxcImFybjphd3M6aWFtOjoxMTExMjIyMjMzMzM6cm9vdFxcXCJcXG5cbiAgICAgICAgICB9LFxcblxuICAgICAgICAgIFxcXCJBY3Rpb25cXFwiIDogXFxcImttczoqXFxcIixcXG5cbiAgICAgICAgICBcXFwiUmVzb3VyY2VcXFwiIDogXFxcIipcXFwiXFxuXG4gICAgICB9IF1cXG5cbiAgICB9YFxuICB9KTtcbiAgY29uc3QgZSA9IHtcbiAgICBSZXF1ZXN0VHlwZTogJ1VwZGF0ZScsXG4gICAgUmVzb3VyY2VQcm9wZXJ0aWVzOiB7XG4gICAgICBDbG91ZEZyb250RGlzdHJpYnV0aW9uSWQ6ICdzYW1wbGUtY2YtZGlzdHJvLWlkJyxcbiAgICAgIEFjY291bnRJZDogJzExMTEyMjIyMzMzMydcbiAgICB9XG4gIH07XG4gIGNvbnN0IGNvbnRleHQgPSB7XG4gICAgLy8gLi4uXG4gIH07XG4gIC8vIEFjdFxuICBjb25zdCByZXMgPSBhd2FpdCBoYW5kbGVyKGUsIGNvbnRleHQpO1xuICAvLyBBc3NlcnRcbiAgZXhwZWN0KHJlcy5TdGF0dXMpLnRvQmUoJ1NVQ0NFU1MnKTtcbn0pO1xuXG5pdCgndXBkYXRlS2V5UG9saWN5KCkgc2hvdWxkIG92ZXJ3cml0ZSBhbiBleGlzdGluZyBrZXkgcG9saWN5IHN0YXRlbWVudCB0aGF0IG1hdGNoZXMgb24gdGhlIHNpZCcsIGFzeW5jICgpID0+IHtcbiAgLy8gQXJyYW5nZVxuICBjb25zdCBrZXlQb2xpY3kgPSB7XG4gICAgVmVyc2lvbjogXCIyMDEyLTEwLTE3XCIsXG4gICAgSWQ6IFwia2V5LWRlZmF1bHQtMVwiLFxuICAgIFN0YXRlbWVudDogW1xuICAgICAge1xuICAgICAgICBTaWQ6ICdHcmFudC1DbG91ZEZyb250LURpc3RyaWJ1dGlvbi1LZXktVXNhZ2UnLFxuICAgICAgICBFZmZlY3Q6IFwiQWxsb3dcIlxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgU2lkOiAnU29tZS1PdGhlci1LZXktUG9saWN5LVN0YXRlbWVudCcsXG4gICAgICAgIEVmZmVjdDogXCJBbGxvd1wiXG4gICAgICB9XG4gICAgXVxuICB9O1xuICBjb25zdCBrZXlQb2xpY3lTdGF0ZW1lbnQgPSB7XG4gICAgU2lkOiAnR3JhbnQtQ2xvdWRGcm9udC1EaXN0cmlidXRpb24tS2V5LVVzYWdlJyxcbiAgICBFZmZlY3Q6IFwiRGVueVwiXG4gIH07XG4gIC8vIEFjdFxuICBjb25zdCByZXMgPSB1cGRhdGVLZXlQb2xpY3koa2V5UG9saWN5LCBrZXlQb2xpY3lTdGF0ZW1lbnQpO1xuICAvLyBBc3NlcnRcbiAgZXhwZWN0KHJlcy5TdGF0ZW1lbnRbMF0uU2lkKS50b0JlKCdHcmFudC1DbG91ZEZyb250LURpc3RyaWJ1dGlvbi1LZXktVXNhZ2UnKTtcbiAgZXhwZWN0KHJlcy5TdGF0ZW1lbnRbMF0uRWZmZWN0KS50b0JlKCdEZW55Jyk7XG59KTtcblxuaXQoJ3VwZGF0ZUtleVBvbGljeSgpIHNob3VsZCBhZGQgdGhlIGtleSBwb2xpY3kgc3RhdGVtZW50IGlmIG9uZSB3aXRoIG1hdGNoaW5nIHNpZCBkb2VzIG5vdCBhbHJlYWR5IGV4aXN0JywgYXN5bmMgKCkgPT4ge1xuICAvLyBBcnJhbmdlXG4gIGNvbnN0IGtleVBvbGljeSA9IHtcbiAgICBWZXJzaW9uOiBcIjIwMTItMTAtMTdcIixcbiAgICBJZDogXCJrZXktZGVmYXVsdC0xXCIsXG4gICAgU3RhdGVtZW50OiBbXG4gICAgICB7XG4gICAgICAgIFNpZDogJ1NvbWUtT3RoZXItS2V5LVBvbGljeS1TdGF0ZW1lbnQnLFxuICAgICAgICBFZmZlY3Q6IFwiQWxsb3dcIlxuICAgICAgfVxuICAgIF1cbiAgfTtcbiAgY29uc3Qga2V5UG9saWN5U3RhdGVtZW50ID0ge1xuICAgIFNpZDogJ0dyYW50LUNsb3VkRnJvbnQtRGlzdHJpYnV0aW9uLUtleS1Vc2FnZScsXG4gICAgRWZmZWN0OiBcIkRlbnlcIlxuICB9O1xuICAvLyBBY3RcbiAgY29uc3QgcmVzID0gdXBkYXRlS2V5UG9saWN5KGtleVBvbGljeSwga2V5UG9saWN5U3RhdGVtZW50KTtcbiAgLy8gQXNzZXJ0XG4gIGV4cGVjdChyZXMuU3RhdGVtZW50WzFdLlNpZCkudG9CZSgnR3JhbnQtQ2xvdWRGcm9udC1EaXN0cmlidXRpb24tS2V5LVVzYWdlJyk7XG4gIGV4cGVjdChyZXMuU3RhdGVtZW50WzFdLkVmZmVjdCkudG9CZSgnRGVueScpO1xufSk7XG4iXX0=