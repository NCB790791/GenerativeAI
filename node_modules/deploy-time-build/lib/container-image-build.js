"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ContainerImageBuild = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const crypto_1 = require("crypto");
const fs_1 = require("fs");
const path_1 = require("path");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_codebuild_1 = require("aws-cdk-lib/aws-codebuild");
const aws_ecr_1 = require("aws-cdk-lib/aws-ecr");
const aws_ecs_1 = require("aws-cdk-lib/aws-ecs");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const aws_lambda_1 = require("aws-cdk-lib/aws-lambda");
const aws_s3_assets_1 = require("aws-cdk-lib/aws-s3-assets");
const constructs_1 = require("constructs");
const singleton_project_1 = require("./singleton-project");
/**
 * Build a container image and push it to an ECR repository on deploy-time.
 */
class ContainerImageBuild extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.props = props;
        const handler = new aws_lambda_1.SingletonFunction(this, 'CustomResourceHandler', {
            // Use raw string to avoid from tightening CDK version requirement
            runtime: new aws_lambda_1.Runtime('nodejs18.x', aws_lambda_1.RuntimeFamily.NODEJS),
            code: aws_lambda_1.Code.fromAsset((0, path_1.join)(__dirname, '../lambda/trigger-codebuild/dist')),
            handler: 'index.handler',
            uuid: 'db740fd5-5436-4a84-8a09-e6dfcd01f4f3', // generated for this construct
            lambdaPurpose: 'DeployTimeBuildCustomResourceHandler',
            timeout: aws_cdk_lib_1.Duration.minutes(5),
        });
        // use buildx for cross-platform image build.
        // because soci-snapshotter currently only supports amd64 environment.
        // const armImage = LinuxArmBuildImage.fromCodeBuildImageId('aws/codebuild/amazonlinux2-aarch64-standard:3.0');
        const x64Image = aws_codebuild_1.LinuxBuildImage.fromCodeBuildImageId('aws/codebuild/standard:7.0');
        // const buildImage = props.platform == Platform.LINUX_ARM64 ? armImage : x64Image;
        const buildImage = x64Image;
        let repository = props.repository;
        if (repository === undefined) {
            repository = new aws_ecr_1.Repository(this, 'Repository', { removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY });
            repository.node.defaultChild.addPropertyOverride('EmptyOnDelete', true);
        }
        const project = new singleton_project_1.SingletonProject(this, 'Project', {
            uuid: 'e83729fe-b156-4e70-9bec-452b15847a30',
            projectPurpose: 'ContainerImageBuildAmd64',
            environment: {
                buildImage: buildImage,
                privileged: true,
            },
            vpc: props.vpc,
            buildSpec: aws_codebuild_1.BuildSpec.fromObject({
                version: '0.2',
                phases: {
                    build: {
                        commands: [
                            'current_dir=$(pwd)',
                            'echo "$input"',
                            'mkdir workdir',
                            'cd workdir',
                            'aws s3 cp "$sourceS3Url" temp.zip',
                            'unzip temp.zip',
                            'ls -la',
                            'aws ecr get-login-password | docker login --username AWS --password-stdin $repositoryAuthUri',
                            'aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws',
                            'docker buildx create --use',
                            'docker buildx ls',
                            'eval "$buildCommand"',
                        ],
                    },
                    post_build: {
                        commands: [
                            'echo Build completed on `date`',
                            `
STATUS='SUCCESS'
if [ $CODEBUILD_BUILD_SUCCEEDING -ne 1 ] # Test if the build is failing
then
STATUS='FAILED'
REASON="ContainerImageBuild failed. See CloudWatch Log stream for the detailed reason: 
https://$AWS_REGION.console.aws.amazon.com/cloudwatch/home?region=$AWS_REGION#logsV2:log-groups/log-group/\\$252Faws\\$252Fcodebuild\\$252F$projectName/log-events/$CODEBUILD_LOG_PATH"
fi
cat <<EOF > payload.json
{
  "StackId": "$stackId",
  "RequestId": "$requestId",
  "LogicalResourceId":"$logicalResourceId",
  "PhysicalResourceId": "$imageTag",
  "Status": "$STATUS",
  "Reason": "$REASON",
  "Data": {
    "ImageTag": "$imageTag"
  }
}
EOF
curl -v -i -X PUT -H 'Content-Type:' -d "@payload.json" "$responseURL"
              `,
                        ],
                    },
                },
            }),
        }).project;
        project.role.addManagedPolicy(aws_iam_1.ManagedPolicy.fromAwsManagedPolicyName('AmazonElasticContainerRegistryPublicReadOnly'));
        repository.grantPullPush(project);
        repository.grant(project, 'ecr:DescribeImages');
        handler.addToRolePolicy(new aws_iam_1.PolicyStatement({
            actions: ['codebuild:StartBuild'],
            resources: [project.projectArn],
        }));
        this.grantPrincipal = project.grantPrincipal;
        let assetExclude = props.exclude;
        // automatically read .dockerignore for convenience
        if (assetExclude === undefined && (0, fs_1.existsSync)((0, path_1.join)(props.directory, '.dockerignore'))) {
            assetExclude = (0, fs_1.readFileSync)((0, path_1.join)(props.directory, '.dockerignore')).toString().split('\n');
        }
        const asset = new aws_s3_assets_1.Asset(this, 'Source', {
            ...props,
            exclude: assetExclude,
            path: props.directory,
        });
        asset.grantRead(project);
        const imageTag = props.tag ?? this.getImageHash(asset.assetHash, props);
        const buildCommandOptions = { ...props, tag: imageTag, platform: props.platform?.platform };
        buildCommandOptions.outputs ?? (buildCommandOptions.outputs = []);
        // to enable zstd compression, buildx directly pushes the artifact image to a registry
        // https://aws.amazon.com/blogs/containers/reducing-aws-fargate-startup-times-with-zstd-compressed-container-images/
        buildCommandOptions.outputs.push('type=image', `name=${repository.repositoryUri}:${imageTag}`, 'push=true');
        if (props.zstdCompression) {
            buildCommandOptions.outputs.push('oci-mediatypes=true', 'compression=zstd', 'force-compression=true', 'compression-level=3');
        }
        const buildCommand = this.getDockerBuildCommand(buildCommandOptions);
        const properties = {
            type: 'ContainerImageBuild',
            buildCommand: buildCommand,
            repositoryUri: repository.repositoryUri,
            imageTag,
            codeBuildProjectName: project.projectName,
            sourceS3Url: asset.s3ObjectUrl,
        };
        const custom = new aws_cdk_lib_1.CustomResource(this, 'Resource', {
            serviceToken: handler.functionArn,
            resourceType: 'Custom::CDKContainerImageBuild',
            properties,
        });
        this.repository = repository;
        this.imageTag = custom.getAttString('ImageTag');
    }
    /**
     * Get the instance of {@link DockerImageCode} for a Lambda function image.
     */
    toLambdaDockerImageCode() {
        if (this.props.zstdCompression) {
            throw new Error('You cannot enable zstdCompression for a Lambda image.');
        }
        return aws_lambda_1.DockerImageCode.fromEcr(this.repository, { tagOrDigest: this.imageTag });
    }
    /**
     * Get the instance of {@link ContainerImage} for an ECS task definition.
     */
    toEcsDockerImageCode() {
        return aws_ecs_1.ContainerImage.fromEcrRepository(this.repository, this.imageTag);
    }
    getImageHash(assetHash, props) {
        const extraHash = {};
        if (props.invalidation?.extraHash !== false && props.extraHash) {
            extraHash.user = props.extraHash;
        }
        if (props.invalidation?.buildArgs !== false && props.buildArgs) {
            extraHash.buildArgs = props.buildArgs;
        }
        if (props.invalidation?.buildSecrets !== false && props.buildSecrets) {
            extraHash.buildSecrets = props.buildSecrets;
        }
        if (props.invalidation?.buildSsh !== false && props.buildSsh) {
            extraHash.buildSsh = props.buildSsh;
        }
        if (props.invalidation?.target !== false && props.target) {
            extraHash.target = props.target;
        }
        if (props.invalidation?.file !== false && props.file) {
            extraHash.file = props.file;
        }
        if (props.invalidation?.repositoryName !== false && props.repositoryName) {
            extraHash.repositoryName = props.repositoryName;
        }
        if (props.invalidation?.networkMode !== false && props.networkMode) {
            extraHash.networkMode = props.networkMode;
        }
        if (props.invalidation?.platform !== false && props.platform) {
            extraHash.platform = props.platform.platform;
        }
        if (props.invalidation?.outputs !== false && props.outputs) {
            extraHash.outputs = props.outputs;
        }
        if (props.zstdCompression) {
            extraHash.zstdCompression = props.zstdCompression;
        }
        return (0, crypto_1.createHash)('md5')
            .update(assetHash + JSON.stringify(extraHash))
            .digest('hex');
    }
    getDockerBuildCommand(options) {
        // the members of props differs with CDK version.
        // By regarding props as any, we can use props that are not available in older cdk versions.
        // logic is copied from packages/cdk-assets/lib/private/docker.ts
        const cacheOptionToFlag = (option) => {
            let flag = `type=${option.type}`;
            if (option.params) {
                flag +=
                    ',' +
                        Object.entries(option.params)
                            .map(([k, v]) => `${k}=${v}`)
                            .join(',');
            }
            return flag;
        };
        const flatten = (x) => {
            return Array.prototype.concat([], ...x);
        };
        const dockerBuildCommand = [
            'docker buildx build',
            ...flatten(Object.entries(options.buildArgs || {}).map(([k, v]) => ['--build-arg', `${k}=${v}`])),
            ...flatten(Object.entries(options.buildSecrets || {}).map(([k, v]) => ['--secret', `id=${k},${v}`])),
            ...(options.buildSsh ? ['--ssh', options.buildSsh] : []),
            ...(options.target ? ['--target', options.target] : []),
            ...(options.file ? ['--file', options.file] : []),
            ...(options.networkMode ? ['--network', options.networkMode] : []),
            ...(options.platform ? ['--platform', options.platform] : []),
            ...(options.outputs ? ['--output', options.outputs.join(',')] : []),
            ...(options.cacheFrom ? [...options.cacheFrom.map((cacheFrom) => ['--cache-from', cacheOptionToFlag(cacheFrom)]).flat()] : []),
            ...(options.cacheTo ? ['--cache-to', cacheOptionToFlag(options.cacheTo)] : []),
            ...(options.cacheDisabled ? ['--no-cache'] : []),
            '--provenance=false',
            '.',
        ];
        return dockerBuildCommand.join(' ');
    }
}
exports.ContainerImageBuild = ContainerImageBuild;
_a = JSII_RTTI_SYMBOL_1;
ContainerImageBuild[_a] = { fqn: "deploy-time-build.ContainerImageBuild", version: "0.3.24" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGFpbmVyLWltYWdlLWJ1aWxkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbnRhaW5lci1pbWFnZS1idWlsZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLG1DQUFvQztBQUNwQywyQkFBOEM7QUFDOUMsK0JBQTRCO0FBQzVCLDZDQUFtRjtBQUNuRiw2REFBdUU7QUFFdkUsaURBQThEO0FBRTlELGlEQUFxRDtBQUNyRCxpREFBNkY7QUFDN0YsdURBQTBHO0FBQzFHLDZEQUFrRDtBQUNsRCwyQ0FBdUM7QUFDdkMsMkRBQXVEO0FBZ0N2RDs7R0FFRztBQUNILE1BQWEsbUJBQW9CLFNBQVEsc0JBQVM7SUFLaEQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBbUIsS0FBK0I7UUFDeEYsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUR3QyxVQUFLLEdBQUwsS0FBSyxDQUEwQjtRQUd4RixNQUFNLE9BQU8sR0FBRyxJQUFJLDhCQUFpQixDQUFDLElBQUksRUFBRSx1QkFBdUIsRUFBRTtZQUNuRSxrRUFBa0U7WUFDbEUsT0FBTyxFQUFFLElBQUksb0JBQU8sQ0FBQyxZQUFZLEVBQUUsMEJBQWEsQ0FBQyxNQUFNLENBQUM7WUFDeEQsSUFBSSxFQUFFLGlCQUFJLENBQUMsU0FBUyxDQUFDLElBQUEsV0FBSSxFQUFDLFNBQVMsRUFBRSxrQ0FBa0MsQ0FBQyxDQUFDO1lBQ3pFLE9BQU8sRUFBRSxlQUFlO1lBQ3hCLElBQUksRUFBRSxzQ0FBc0MsRUFBRSwrQkFBK0I7WUFDN0UsYUFBYSxFQUFFLHNDQUFzQztZQUNyRCxPQUFPLEVBQUUsc0JBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1NBQzdCLENBQUMsQ0FBQztRQUVILDZDQUE2QztRQUM3QyxzRUFBc0U7UUFDdEUsK0dBQStHO1FBQy9HLE1BQU0sUUFBUSxHQUFHLCtCQUFlLENBQUMsb0JBQW9CLENBQUMsNEJBQTRCLENBQUMsQ0FBQztRQUNw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QUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQ25FLEdBQUcsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFjLEVBQUUsRUFBRSxDQUFDLENBQUMsY0FBYyxFQUFFLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDbkksR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxFQUFFLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDOUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUNoRCxvQkFBb0I7WUFDcEIsR0FBRztTQUNKLENBQUM7UUFDRixPQUFPLGtCQUFrQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN0QyxDQUFDOztBQS9PSCxrREFnUEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjcmVhdGVIYXNoIH0gZnJvbSAnY3J5cHRvJztcbmltcG9ydCB7IGV4aXN0c1N5bmMsIHJlYWRGaWxlU3luYyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IENmblJlc291cmNlLCBDdXN0b21SZXNvdXJjZSwgRHVyYXRpb24sIFJlbW92YWxQb2xpY3kgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBCdWlsZFNwZWMsIExpbnV4QnVpbGRJbWFnZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1jb2RlYnVpbGQnO1xuaW1wb3J0IHsgSVZwYyB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1lYzInO1xuaW1wb3J0IHsgSVJlcG9zaXRvcnksIFJlcG9zaXRvcnkgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWNyJztcbmltcG9ydCB7IERvY2tlckltYWdlQXNzZXRQcm9wcyB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1lY3ItYXNzZXRzJztcbmltcG9ydCB7IENvbnRhaW5lckltYWdlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWVjcyc7XG5pbXBvcnQgeyBJR3JhbnRhYmxlLCBJUHJpbmNpcGFsLCBNYW5hZ2VkUG9saWN5LCBQb2xpY3lTdGF0ZW1lbnQgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IENvZGUsIERvY2tlckltYWdlQ29kZSwgUnVudGltZSwgUnVudGltZUZhbWlseSwgU2luZ2xldG9uRnVuY3Rpb24gfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCB7IEFzc2V0IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLXMzLWFzc2V0cyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IFNpbmdsZXRvblByb2plY3QgfSBmcm9tICcuL3NpbmdsZXRvbi1wcm9qZWN0JztcbmltcG9ydCB7IENvbnRhaW5lckltYWdlQnVpbGRSZXNvdXJjZVByb3BzIH0gZnJvbSAnLi90eXBlcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29udGFpbmVySW1hZ2VCdWlsZFByb3BzIGV4dGVuZHMgRG9ja2VySW1hZ2VBc3NldFByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSB0YWcgd2hlbiB0byBwdXNoIHRoZSBpbWFnZVxuICAgKiBAZGVmYXVsdCB1c2UgYXNzZXRIYXNoIGFzIHRhZ1xuICAgKi9cbiAgcmVhZG9ubHkgdGFnPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgRUNSIHJlcG9zaXRvcnkgdG8gcHVzaCB0aGUgaW1hZ2UuXG4gICAqIEBkZWZhdWx0IGNyZWF0ZSBhIG5ldyBFQ1IgcmVwb3NpdG9yeVxuICAgKi9cbiAgcmVhZG9ubHkgcmVwb3NpdG9yeT86IElSZXBvc2l0b3J5O1xuXG4gIC8qKlxuICAgKiBVc2UgenN0ZCBmb3IgY29tcHJlc3NpbmcgYSBjb250YWluZXIgaW1hZ2UuXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICByZWFkb25seSB6c3RkQ29tcHJlc3Npb24/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBUaGUgVlBDIHdoZXJlIHlvdXIgYnVpbGQgam9iIHdpbGwgYmUgZGVwbG95ZWQuXG4gICAqIFRoaXMgVlBDIG11c3QgaGF2ZSBwcml2YXRlIHN1Ym5ldHMgd2l0aCBOQVQgR2F0ZXdheXMuXG4gICAqXG4gICAqIFVzZSB0aGlzIHByb3BlcnR5IHdoZW4geW91IHdhbnQgdG8gY29udHJvbCB0aGUgb3V0Ym91bmQgSVAgYWRkcmVzc2VzIHRoYXQgYmFzZSBpbWFnZXMgYXJlIHB1bGxlZCBmcm9tLlxuICAgKiBAZGVmYXVsdCBObyBWUEMgdXNlZC5cbiAgICovXG4gIHJlYWRvbmx5IHZwYz86IElWcGM7XG59XG5cbi8qKlxuICogQnVpbGQgYSBjb250YWluZXIgaW1hZ2UgYW5kIHB1c2ggaXQgdG8gYW4gRUNSIHJlcG9zaXRvcnkgb24gZGVwbG95LXRpbWUuXG4gKi9cbmV4cG9ydCBjbGFzcyBDb250YWluZXJJbWFnZUJ1aWxkIGV4dGVuZHMgQ29uc3RydWN0IGltcGxlbWVudHMgSUdyYW50YWJsZSB7XG4gIHB1YmxpYyByZWFkb25seSBncmFudFByaW5jaXBhbDogSVByaW5jaXBhbDtcbiAgcHVibGljIHJlYWRvbmx5IHJlcG9zaXRvcnk6IElSZXBvc2l0b3J5O1xuICBwdWJsaWMgcmVhZG9ubHkgaW1hZ2VUYWc6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcml2YXRlIHJlYWRvbmx5IHByb3BzOiBDb250YWluZXJJbWFnZUJ1aWxkUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3QgaGFuZGxlciA9IG5ldyBTaW5nbGV0b25GdW5jdGlvbih0aGlzLCAnQ3VzdG9tUmVzb3VyY2VIYW5kbGVyJywge1xuICAgICAgLy8gVXNlIHJhdyBzdHJpbmcgdG8gYXZvaWQgZnJvbSB0aWdodGVuaW5nIENESyB2ZXJzaW9uIHJlcXVpcmVtZW50XG4gICAgICBydW50aW1lOiBuZXcgUnVudGltZSgnbm9kZWpzMTgueCcsIFJ1bnRpbWVGYW1pbHkuTk9ERUpTKSxcbiAgICAgIGNvZGU6IENvZGUuZnJvbUFzc2V0KGpvaW4oX19kaXJuYW1lLCAnLi4vbGFtYmRhL3RyaWdnZXItY29kZWJ1aWxkL2Rpc3QnKSksXG4gICAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXG4gICAgICB1dWlkOiAnZGI3NDBmZDUtNTQzNi00YTg0LThhMDktZTZkZmNkMDFmNGYzJywgLy8gZ2VuZXJhdGVkIGZvciB0aGlzIGNvbnN0cnVjdFxuICAgICAgbGFtYmRhUHVycG9zZTogJ0RlcGxveVRpbWVCdWlsZEN1c3RvbVJlc291cmNlSGFuZGxlcicsXG4gICAgICB0aW1lb3V0OiBEdXJhdGlvbi5taW51dGVzKDUpLFxuICAgIH0pO1xuXG4gICAgLy8gdXNlIGJ1aWxkeCBmb3IgY3Jvc3MtcGxhdGZvcm0gaW1hZ2UgYnVpbGQuXG4gICAgLy8gYmVjYXVzZSBzb2NpLXNuYXBzaG90dGVyIGN1cnJlbnRseSBvbmx5IHN1cHBvcnRzIGFtZDY0IGVudmlyb25tZW50LlxuICAgIC8vIGNvbnN0IGFybUltYWdlID0gTGludXhBcm1CdWlsZEltYWdlLmZyb21Db2RlQnVpbGRJbWFnZUlkKCdhd3MvY29kZWJ1aWxkL2FtYXpvbmxpbnV4Mi1hYXJjaDY0LXN0YW5kYXJkOjMuMCcpO1xuICAgIGNvbnN0IHg2NEltYWdlID0gTGludXhCdWlsZEltYWdlLmZyb21Db2RlQnVpbGRJbWFnZUlkKCdhd3MvY29kZWJ1aWxkL3N0YW5kYXJkOjcuMCcpO1xuICAgIC8vIGNvbnN0IGJ1aWxkSW1hZ2UgPSBwcm9wcy5wbGF0Zm9ybSA9PSBQbGF0Zm9ybS5MSU5VWF9BUk02NCA/IGFybUltYWdlIDogeDY0SW1hZ2U7XG4gICAgY29uc3QgYnVpbGRJbWFnZSA9IHg2NEltYWdlO1xuXG4gICAgbGV0IHJlcG9zaXRvcnkgPSBwcm9wcy5yZXBvc2l0b3J5O1xuICAgIGlmIChyZXBvc2l0b3J5ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJlcG9zaXRvcnkgPSBuZXcgUmVwb3NpdG9yeSh0aGlzLCAnUmVwb3NpdG9yeScsIHsgcmVtb3ZhbFBvbGljeTogUmVtb3ZhbFBvbGljeS5ERVNUUk9ZIH0pO1xuICAgICAgKHJlcG9zaXRvcnkubm9kZS5kZWZhdWx0Q2hpbGQgYXMgQ2ZuUmVzb3VyY2UpLmFkZFByb3BlcnR5T3ZlcnJpZGUoJ0VtcHR5T25EZWxldGUnLCB0cnVlKTtcbiAgICB9XG5cbiAgICBjb25zdCBwcm9qZWN0ID0gbmV3IFNpbmdsZXRvblByb2plY3QodGhpcywgJ1Byb2plY3QnLCB7XG4gICAgICB1dWlkOiAnZTgzNzI5ZmUtYjE1Ni00ZTcwLTliZWMtNDUyYjE1ODQ3YTMwJyxcbiAgICAgIHByb2plY3RQdXJwb3NlOiAnQ29udGFpbmVySW1hZ2VCdWlsZEFtZDY0JyxcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIGJ1aWxkSW1hZ2U6IGJ1aWxkSW1hZ2UsXG4gICAgICAgIHByaXZpbGVnZWQ6IHRydWUsXG4gICAgICB9LFxuICAgICAgdnBjOiBwcm9wcy52cGMsXG4gICAgICBidWlsZFNwZWM6IEJ1aWxkU3BlYy5mcm9tT2JqZWN0KHtcbiAgICAgICAgdmVyc2lvbjogJzAuMicsXG4gICAgICAgIHBoYXNlczoge1xuICAgICAgICAgIGJ1aWxkOiB7XG4gICAgICAgICAgICBjb21tYW5kczogW1xuICAgICAgICAgICAgICAnY3VycmVudF9kaXI9JChwd2QpJyxcbiAgICAgICAgICAgICAgJ2VjaG8gXCIkaW5wdXRcIicsXG4gICAgICAgICAgICAgICdta2RpciB3b3JrZGlyJyxcbiAgICAgICAgICAgICAgJ2NkIHdvcmtkaXInLFxuICAgICAgICAgICAgICAnYXdzIHMzIGNwIFwiJHNvdXJjZVMzVXJsXCIgdGVtcC56aXAnLFxuICAgICAgICAgICAgICAndW56aXAgdGVtcC56aXAnLFxuICAgICAgICAgICAgICAnbHMgLWxhJyxcbiAgICAgICAgICAgICAgJ2F3cyBlY3IgZ2V0LWxvZ2luLXBhc3N3b3JkIHwgZG9ja2VyIGxvZ2luIC0tdXNlcm5hbWUgQVdTIC0tcGFzc3dvcmQtc3RkaW4gJHJlcG9zaXRvcnlBdXRoVXJpJyxcbiAgICAgICAgICAgICAgJ2F3cyBlY3ItcHVibGljIGdldC1sb2dpbi1wYXNzd29yZCAtLXJlZ2lvbiB1cy1lYXN0LTEgfCBkb2NrZXIgbG9naW4gLS11c2VybmFtZSBBV1MgLS1wYXNzd29yZC1zdGRpbiBwdWJsaWMuZWNyLmF3cycsXG4gICAgICAgICAgICAgICdkb2NrZXIgYnVpbGR4IGNyZWF0ZSAtLXVzZScsXG4gICAgICAgICAgICAgICdkb2NrZXIgYnVpbGR4IGxzJyxcbiAgICAgICAgICAgICAgJ2V2YWwgXCIkYnVpbGRDb21tYW5kXCInLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHBvc3RfYnVpbGQ6IHtcbiAgICAgICAgICAgIGNvbW1hbmRzOiBbXG4gICAgICAgICAgICAgICdlY2hvIEJ1aWxkIGNvbXBsZXRlZCBvbiBgZGF0ZWAnLFxuICAgICAgICAgICAgICBgXG5TVEFUVVM9J1NVQ0NFU1MnXG5pZiBbICRDT0RFQlVJTERfQlVJTERfU1VDQ0VFRElORyAtbmUgMSBdICMgVGVzdCBpZiB0aGUgYnVpbGQgaXMgZmFpbGluZ1xudGhlblxuU1RBVFVTPSdGQUlMRUQnXG5SRUFTT049XCJDb250YWluZXJJbWFnZUJ1aWxkIGZhaWxlZC4gU2VlIENsb3VkV2F0Y2ggTG9nIHN0cmVhbSBmb3IgdGhlIGRldGFpbGVkIHJlYXNvbjogXG5odHRwczovLyRBV1NfUkVHSU9OLmNvbnNvbGUuYXdzLmFtYXpvbi5jb20vY2xvdWR3YXRjaC9ob21lP3JlZ2lvbj0kQVdTX1JFR0lPTiNsb2dzVjI6bG9nLWdyb3Vwcy9sb2ctZ3JvdXAvXFxcXCQyNTJGYXdzXFxcXCQyNTJGY29kZWJ1aWxkXFxcXCQyNTJGJHByb2plY3ROYW1lL2xvZy1ldmVudHMvJENPREVCVUlMRF9MT0dfUEFUSFwiXG5maVxuY2F0IDw8RU9GID4gcGF5bG9hZC5qc29uXG57XG4gIFwiU3RhY2tJZFwiOiBcIiRzdGFja0lkXCIsXG4gIFwiUmVxdWVzdElkXCI6IFwiJHJlcXVlc3RJZFwiLFxuICBcIkxvZ2ljYWxSZXNvdXJjZUlkXCI6XCIkbG9naWNhbFJlc291cmNlSWRcIixcbiAgXCJQaHlzaWNhbFJlc291cmNlSWRcIjogXCIkaW1hZ2VUYWdcIixcbiAgXCJTdGF0dXNcIjogXCIkU1RBVFVTXCIsXG4gIFwiUmVhc29uXCI6IFwiJFJFQVNPTlwiLFxuICBcIkRhdGFcIjoge1xuICAgIFwiSW1hZ2VUYWdcIjogXCIkaW1hZ2VUYWdcIlxuICB9XG59XG5FT0ZcbmN1cmwgLXYgLWkgLVggUFVUIC1IICdDb250ZW50LVR5cGU6JyAtZCBcIkBwYXlsb2FkLmpzb25cIiBcIiRyZXNwb25zZVVSTFwiXG4gICAgICAgICAgICAgIGAsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KSxcbiAgICB9KS5wcm9qZWN0O1xuXG4gICAgcHJvamVjdC5yb2xlIS5hZGRNYW5hZ2VkUG9saWN5KE1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKCdBbWF6b25FbGFzdGljQ29udGFpbmVyUmVnaXN0cnlQdWJsaWNSZWFkT25seScpKTtcbiAgICByZXBvc2l0b3J5LmdyYW50UHVsbFB1c2gocHJvamVjdCk7XG4gICAgcmVwb3NpdG9yeS5ncmFudChwcm9qZWN0LCAnZWNyOkRlc2NyaWJlSW1hZ2VzJyk7XG5cbiAgICBoYW5kbGVyLmFkZFRvUm9sZVBvbGljeShcbiAgICAgIG5ldyBQb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBhY3Rpb25zOiBbJ2NvZGVidWlsZDpTdGFydEJ1aWxkJ10sXG4gICAgICAgIHJlc291cmNlczogW3Byb2plY3QucHJvamVjdEFybl0sXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgdGhpcy5ncmFudFByaW5jaXBhbCA9IHByb2plY3QuZ3JhbnRQcmluY2lwYWw7XG5cbiAgICBsZXQgYXNzZXRFeGNsdWRlID0gcHJvcHMuZXhjbHVkZTtcbiAgICAvLyBhdXRvbWF0aWNhbGx5IHJlYWQgLmRvY2tlcmlnbm9yZSBmb3IgY29udmVuaWVuY2VcbiAgICBpZiAoYXNzZXRFeGNsdWRlID09PSB1bmRlZmluZWQgJiYgZXhpc3RzU3luYyhqb2luKHByb3BzLmRpcmVjdG9yeSwgJy5kb2NrZXJpZ25vcmUnKSkpIHtcbiAgICAgIGFzc2V0RXhjbHVkZSA9IHJlYWRGaWxlU3luYyhqb2luKHByb3BzLmRpcmVjdG9yeSwgJy5kb2NrZXJpZ25vcmUnKSkudG9TdHJpbmcoKS5zcGxpdCgnXFxuJyk7XG4gICAgfVxuICAgIGNvbnN0IGFzc2V0ID0gbmV3IEFzc2V0KHRoaXMsICdTb3VyY2UnLCB7XG4gICAgICAuLi5wcm9wcyxcbiAgICAgIGV4Y2x1ZGU6IGFzc2V0RXhjbHVkZSxcbiAgICAgIHBhdGg6IHByb3BzLmRpcmVjdG9yeSxcbiAgICB9KTtcbiAgICBhc3NldC5ncmFudFJlYWQocHJvamVjdCk7XG5cbiAgICBjb25zdCBpbWFnZVRhZyA9IHByb3BzLnRhZyA/PyB0aGlzLmdldEltYWdlSGFzaChhc3NldC5hc3NldEhhc2gsIHByb3BzKTtcbiAgICBjb25zdCBidWlsZENvbW1hbmRPcHRpb25zID0geyAuLi5wcm9wcywgdGFnOiBpbWFnZVRhZywgcGxhdGZvcm06IHByb3BzLnBsYXRmb3JtPy5wbGF0Zm9ybSB9IGFzIGFueTtcbiAgICBidWlsZENvbW1hbmRPcHRpb25zLm91dHB1dHMgPz89IFtdO1xuICAgIC8vIHRvIGVuYWJsZSB6c3RkIGNvbXByZXNzaW9uLCBidWlsZHggZGlyZWN0bHkgcHVzaGVzIHRoZSBhcnRpZmFjdCBpbWFnZSB0byBhIHJlZ2lzdHJ5XG4gICAgLy8gaHR0cHM6Ly9hd3MuYW1hem9uLmNvbS9ibG9ncy9jb250YWluZXJzL3JlZHVjaW5nLWF3cy1mYXJnYXRlLXN0YXJ0dXAtdGltZXMtd2l0aC16c3RkLWNvbXByZXNzZWQtY29udGFpbmVyLWltYWdlcy9cbiAgICBidWlsZENvbW1hbmRPcHRpb25zLm91dHB1dHMucHVzaCgndHlwZT1pbWFnZScsIGBuYW1lPSR7cmVwb3NpdG9yeS5yZXBvc2l0b3J5VXJpfToke2ltYWdlVGFnfWAsICdwdXNoPXRydWUnKTtcbiAgICBpZiAocHJvcHMuenN0ZENvbXByZXNzaW9uKSB7XG4gICAgICBidWlsZENvbW1hbmRPcHRpb25zLm91dHB1dHMucHVzaCgnb2NpLW1lZGlhdHlwZXM9dHJ1ZScsICdjb21wcmVzc2lvbj16c3RkJywgJ2ZvcmNlLWNvbXByZXNzaW9uPXRydWUnLCAnY29tcHJlc3Npb24tbGV2ZWw9MycpO1xuICAgIH1cbiAgICBjb25zdCBidWlsZENvbW1hbmQgPSB0aGlzLmdldERvY2tlckJ1aWxkQ29tbWFuZChidWlsZENvbW1hbmRPcHRpb25zKTtcblxuICAgIGNvbnN0IHByb3BlcnRpZXM6IENvbnRhaW5lckltYWdlQnVpbGRSZXNvdXJjZVByb3BzID0ge1xuICAgICAgdHlwZTogJ0NvbnRhaW5lckltYWdlQnVpbGQnLFxuICAgICAgYnVpbGRDb21tYW5kOiBidWlsZENvbW1hbmQsXG4gICAgICByZXBvc2l0b3J5VXJpOiByZXBvc2l0b3J5LnJlcG9zaXRvcnlVcmksXG4gICAgICBpbWFnZVRhZyxcbiAgICAgIGNvZGVCdWlsZFByb2plY3ROYW1lOiBwcm9qZWN0LnByb2plY3ROYW1lLFxuICAgICAgc291cmNlUzNVcmw6IGFzc2V0LnMzT2JqZWN0VXJsLFxuICAgIH07XG5cbiAgICBjb25zdCBjdXN0b20gPSBuZXcgQ3VzdG9tUmVzb3VyY2UodGhpcywgJ1Jlc291cmNlJywge1xuICAgICAgc2VydmljZVRva2VuOiBoYW5kbGVyLmZ1bmN0aW9uQXJuLFxuICAgICAgcmVzb3VyY2VUeXBlOiAnQ3VzdG9tOjpDREtDb250YWluZXJJbWFnZUJ1aWxkJyxcbiAgICAgIHByb3BlcnRpZXMsXG4gICAgfSk7XG5cbiAgICB0aGlzLnJlcG9zaXRvcnkgPSByZXBvc2l0b3J5O1xuICAgIHRoaXMuaW1hZ2VUYWcgPSBjdXN0b20uZ2V0QXR0U3RyaW5nKCdJbWFnZVRhZycpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgaW5zdGFuY2Ugb2Yge0BsaW5rIERvY2tlckltYWdlQ29kZX0gZm9yIGEgTGFtYmRhIGZ1bmN0aW9uIGltYWdlLlxuICAgKi9cbiAgcHVibGljIHRvTGFtYmRhRG9ja2VySW1hZ2VDb2RlKCkge1xuICAgIGlmICh0aGlzLnByb3BzLnpzdGRDb21wcmVzc2lvbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdZb3UgY2Fubm90IGVuYWJsZSB6c3RkQ29tcHJlc3Npb24gZm9yIGEgTGFtYmRhIGltYWdlLicpO1xuICAgIH1cbiAgICByZXR1cm4gRG9ja2VySW1hZ2VDb2RlLmZyb21FY3IodGhpcy5yZXBvc2l0b3J5LCB7IHRhZ09yRGlnZXN0OiB0aGlzLmltYWdlVGFnIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgaW5zdGFuY2Ugb2Yge0BsaW5rIENvbnRhaW5lckltYWdlfSBmb3IgYW4gRUNTIHRhc2sgZGVmaW5pdGlvbi5cbiAgICovXG4gIHB1YmxpYyB0b0Vjc0RvY2tlckltYWdlQ29kZSgpIHtcbiAgICByZXR1cm4gQ29udGFpbmVySW1hZ2UuZnJvbUVjclJlcG9zaXRvcnkodGhpcy5yZXBvc2l0b3J5LCB0aGlzLmltYWdlVGFnKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0SW1hZ2VIYXNoKGFzc2V0SGFzaDogc3RyaW5nLCBwcm9wczogYW55KSB7XG4gICAgY29uc3QgZXh0cmFIYXNoOiB7IFtmaWVsZDogc3RyaW5nXTogYW55IH0gPSB7fTtcbiAgICBpZiAocHJvcHMuaW52YWxpZGF0aW9uPy5leHRyYUhhc2ggIT09IGZhbHNlICYmIHByb3BzLmV4dHJhSGFzaCkge1xuICAgICAgZXh0cmFIYXNoLnVzZXIgPSBwcm9wcy5leHRyYUhhc2g7XG4gICAgfVxuICAgIGlmIChwcm9wcy5pbnZhbGlkYXRpb24/LmJ1aWxkQXJncyAhPT0gZmFsc2UgJiYgcHJvcHMuYnVpbGRBcmdzKSB7XG4gICAgICBleHRyYUhhc2guYnVpbGRBcmdzID0gcHJvcHMuYnVpbGRBcmdzO1xuICAgIH1cbiAgICBpZiAocHJvcHMuaW52YWxpZGF0aW9uPy5idWlsZFNlY3JldHMgIT09IGZhbHNlICYmIHByb3BzLmJ1aWxkU2VjcmV0cykge1xuICAgICAgZXh0cmFIYXNoLmJ1aWxkU2VjcmV0cyA9IHByb3BzLmJ1aWxkU2VjcmV0cztcbiAgICB9XG4gICAgaWYgKHByb3BzLmludmFsaWRhdGlvbj8uYnVpbGRTc2ggIT09IGZhbHNlICYmIHByb3BzLmJ1aWxkU3NoKSB7XG4gICAgICBleHRyYUhhc2guYnVpbGRTc2ggPSBwcm9wcy5idWlsZFNzaDtcbiAgICB9XG4gICAgaWYgKHByb3BzLmludmFsaWRhdGlvbj8udGFyZ2V0ICE9PSBmYWxzZSAmJiBwcm9wcy50YXJnZXQpIHtcbiAgICAgIGV4dHJhSGFzaC50YXJnZXQgPSBwcm9wcy50YXJnZXQ7XG4gICAgfVxuICAgIGlmIChwcm9wcy5pbnZhbGlkYXRpb24/LmZpbGUgIT09IGZhbHNlICYmIHByb3BzLmZpbGUpIHtcbiAgICAgIGV4dHJhSGFzaC5maWxlID0gcHJvcHMuZmlsZTtcbiAgICB9XG4gICAgaWYgKHByb3BzLmludmFsaWRhdGlvbj8ucmVwb3NpdG9yeU5hbWUgIT09IGZhbHNlICYmIHByb3BzLnJlcG9zaXRvcnlOYW1lKSB7XG4gICAgICBleHRyYUhhc2gucmVwb3NpdG9yeU5hbWUgPSBwcm9wcy5yZXBvc2l0b3J5TmFtZTtcbiAgICB9XG4gICAgaWYgKHByb3BzLmludmFsaWRhdGlvbj8ubmV0d29ya01vZGUgIT09IGZhbHNlICYmIHByb3BzLm5ldHdvcmtNb2RlKSB7XG4gICAgICBleHRyYUhhc2gubmV0d29ya01vZGUgPSBwcm9wcy5uZXR3b3JrTW9kZTtcbiAgICB9XG4gICAgaWYgKHByb3BzLmludmFsaWRhdGlvbj8ucGxhdGZvcm0gIT09IGZhbHNlICYmIHByb3BzLnBsYXRmb3JtKSB7XG4gICAgICBleHRyYUhhc2gucGxhdGZvcm0gPSBwcm9wcy5wbGF0Zm9ybS5wbGF0Zm9ybTtcbiAgICB9XG4gICAgaWYgKHByb3BzLmludmFsaWRhdGlvbj8ub3V0cHV0cyAhPT0gZmFsc2UgJiYgcHJvcHMub3V0cHV0cykge1xuICAgICAgZXh0cmFIYXNoLm91dHB1dHMgPSBwcm9wcy5vdXRwdXRzO1xuICAgIH1cbiAgICBpZiAocHJvcHMuenN0ZENvbXByZXNzaW9uKSB7XG4gICAgICBleHRyYUhhc2guenN0ZENvbXByZXNzaW9uID0gcHJvcHMuenN0ZENvbXByZXNzaW9uO1xuICAgIH1cbiAgICByZXR1cm4gY3JlYXRlSGFzaCgnbWQ1JylcbiAgICAgIC51cGRhdGUoYXNzZXRIYXNoICsgSlNPTi5zdHJpbmdpZnkoZXh0cmFIYXNoKSlcbiAgICAgIC5kaWdlc3QoJ2hleCcpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREb2NrZXJCdWlsZENvbW1hbmQob3B0aW9uczogYW55KSB7XG4gICAgLy8gdGhlIG1lbWJlcnMgb2YgcHJvcHMgZGlmZmVycyB3aXRoIENESyB2ZXJzaW9uLlxuICAgIC8vIEJ5IHJlZ2FyZGluZyBwcm9wcyBhcyBhbnksIHdlIGNhbiB1c2UgcHJvcHMgdGhhdCBhcmUgbm90IGF2YWlsYWJsZSBpbiBvbGRlciBjZGsgdmVyc2lvbnMuXG5cbiAgICAvLyBsb2dpYyBpcyBjb3BpZWQgZnJvbSBwYWNrYWdlcy9jZGstYXNzZXRzL2xpYi9wcml2YXRlL2RvY2tlci50c1xuICAgIGNvbnN0IGNhY2hlT3B0aW9uVG9GbGFnID0gKG9wdGlvbjogYW55KTogc3RyaW5nID0+IHtcbiAgICAgIGxldCBmbGFnID0gYHR5cGU9JHtvcHRpb24udHlwZX1gO1xuICAgICAgaWYgKG9wdGlvbi5wYXJhbXMpIHtcbiAgICAgICAgZmxhZyArPVxuICAgICAgICAgICcsJyArXG4gICAgICAgICAgT2JqZWN0LmVudHJpZXMob3B0aW9uLnBhcmFtcylcbiAgICAgICAgICAgIC5tYXAoKFtrLCB2XSkgPT4gYCR7a309JHt2fWApXG4gICAgICAgICAgICAuam9pbignLCcpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZsYWc7XG4gICAgfTtcbiAgICBjb25zdCBmbGF0dGVuID0gKHg6IHN0cmluZ1tdW10pID0+IHtcbiAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuY29uY2F0KFtdLCAuLi54KTtcbiAgICB9O1xuXG4gICAgY29uc3QgZG9ja2VyQnVpbGRDb21tYW5kID0gW1xuICAgICAgJ2RvY2tlciBidWlsZHggYnVpbGQnLFxuICAgICAgLi4uZmxhdHRlbihPYmplY3QuZW50cmllcyhvcHRpb25zLmJ1aWxkQXJncyB8fCB7fSkubWFwKChbaywgdl0pID0+IFsnLS1idWlsZC1hcmcnLCBgJHtrfT0ke3Z9YF0pKSxcbiAgICAgIC4uLmZsYXR0ZW4oT2JqZWN0LmVudHJpZXMob3B0aW9ucy5idWlsZFNlY3JldHMgfHwge30pLm1hcCgoW2ssIHZdKSA9PiBbJy0tc2VjcmV0JywgYGlkPSR7a30sJHt2fWBdKSksXG4gICAgICAuLi4ob3B0aW9ucy5idWlsZFNzaCA/IFsnLS1zc2gnLCBvcHRpb25zLmJ1aWxkU3NoXSA6IFtdKSxcbiAgICAgIC4uLihvcHRpb25zLnRhcmdldCA/IFsnLS10YXJnZXQnLCBvcHRpb25zLnRhcmdldF0gOiBbXSksXG4gICAgICAuLi4ob3B0aW9ucy5maWxlID8gWyctLWZpbGUnLCBvcHRpb25zLmZpbGVdIDogW10pLFxuICAgICAgLi4uKG9wdGlvbnMubmV0d29ya01vZGUgPyBbJy0tbmV0d29yaycsIG9wdGlvbnMubmV0d29ya01vZGVdIDogW10pLFxuICAgICAgLi4uKG9wdGlvbnMucGxhdGZvcm0gPyBbJy0tcGxhdGZvcm0nLCBvcHRpb25zLnBsYXRmb3JtXSA6IFtdKSxcbiAgICAgIC4uLihvcHRpb25zLm91dHB1dHMgPyBbJy0tb3V0cHV0Jywgb3B0aW9ucy5vdXRwdXRzLmpvaW4oJywnKV0gOiBbXSksXG4gICAgICAuLi4ob3B0aW9ucy5jYWNoZUZyb20gPyBbLi4ub3B0aW9ucy5jYWNoZUZyb20ubWFwKChjYWNoZUZyb206IGFueSkgPT4gWyctLWNhY2hlLWZyb20nLCBjYWNoZU9wdGlvblRvRmxhZyhjYWNoZUZyb20pXSkuZmxhdCgpXSA6IFtdKSxcbiAgICAgIC4uLihvcHRpb25zLmNhY2hlVG8gPyBbJy0tY2FjaGUtdG8nLCBjYWNoZU9wdGlvblRvRmxhZyhvcHRpb25zLmNhY2hlVG8pXSA6IFtdKSxcbiAgICAgIC4uLihvcHRpb25zLmNhY2hlRGlzYWJsZWQgPyBbJy0tbm8tY2FjaGUnXSA6IFtdKSxcbiAgICAgICctLXByb3ZlbmFuY2U9ZmFsc2UnLFxuICAgICAgJy4nLFxuICAgIF07XG4gICAgcmV0dXJuIGRvY2tlckJ1aWxkQ29tbWFuZC5qb2luKCcgJyk7XG4gIH1cbn1cbiJdfQ==